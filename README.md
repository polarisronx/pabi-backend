<h1 align="center">Polaris BI æ™ºèƒ½æ•°æ®åˆ†æå¹³å°</h1>
<p align="center"><strong>Pabi æ˜¯ä¸€ä¸ªä¸ºç”¨æˆ·å’Œå¼€å‘è€…æä¾›å®‰å…¨å¯é çš„æ•°æ®åˆ†ææœåŠ¡çš„å¹³å° ğŸ› </strong></p>
<div align="center">
	<a target="_blank" href="https://github.com/polarisronx/Papi-backend">
    	<img alt="" src="https://github.com/qimu666/qi-api/badge/star.svg?theme=gvp"/>
	</a>
    <img alt="Maven" src="https://raster.shields.io/badge/Maven-3.8.2-red.svg"/>
    <img alt="SpringBoot" src="https://raster.shields.io/badge/SpringBoot-2.7+-green.svg"/>
    <a target="_blank" href="https://www.oracle.com/technetwork/java/javase/downloads/index.html">
        <img alt="" src="https://img.shields.io/badge/JDK-1.8+-green.svg"/>
	</a></div>


## ä»€ä¹ˆæ˜¯ PaBI

åŸºäºSpring Boot + MQ + AIGC + Reactçš„æ™ºèƒ½æ•°æ®åˆ†æå¹³å°ã€‚åŒºåˆ«äºä¼ ç»ŸBï¼Œç”¨æˆ·åªéœ€è¦å¯¼å…¥åŸå§‹æ•°æ®é›†ã€å¹¶è¾“å…¥åˆ†æè¯‰æ±‚ï¼Œå°±èƒ½è‡ªåŠ¨ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨åŠåˆ†æç»“è®ºï¼Œå®ç°æ•°æ®åˆ†æçš„é™æœ¬å¢æ•ˆ(æˆ–è€…é™ä½æ•°æ®åˆ†æçš„äººå·¥æˆæœ¬ã€æé«˜æ•°æ®åˆ†ææ•ˆç‡ç­‰)ã€‚

- æ‚¨å¯ä»¥å‰å¾€ <a href="https://api.papi.icu">Pabi æ™ºèƒ½æ•°æ®åˆ†æå¹³å°</a> åœ¨çº¿å°è¯•ã€‚

> æˆ‘ä»¬ä¹Ÿæ¨èæ‚¨å‰å¾€æˆ‘ä»¬æ–°å¼€å‘çš„ <a href="api.papi.icu">Polaris API</a> åœ¨çº¿å¼€æ”¾å¹³å°ï¼Œç›®å‰æ­£åœ¨å†…æµ‹âœ¨

## æºç æŒ‡å—

<a href="https://github.com/polarisronx/pabi-backend">Pabi åç«¯é¡¹ç›®</a>

<a href="https://github.com/polarisronx/pabi-frontend">Pabi å‰ç«¯é¡¹ç›®</a>

## å¿«é€Ÿå¯åŠ¨

### å‰ç«¯

ç¯å¢ƒè¦æ±‚ï¼šNode.js >= 16ï¼Œyarn æˆ– npm åŒ…ä¾èµ–å·¥å…·

1. å®‰è£…ä¾èµ–ï¼šnpm æˆ– yarn å‡å¯

```bash
yarn install
npm install
```

2. å¯åŠ¨ï¼šnpm æˆ– yarn å‡å¯

```bash
yarn run start
npm run start
```

3. éƒ¨ç½²ï¼šnpm æˆ– yarn å‡å¯

```bash
yarn run build
npm run build
```

### åç«¯

1. æ‰§è¡Œsqlç›®å½•ä¸‹ddl.sqlåœ¨æ•°æ®åº“ä¸­ç”Ÿæˆå¯¹åº”åº“è¡¨ï¼›
2. å¯åŠ¨ Redisï¼›
3. ä¿®æ”¹é¡¹ç›®é…ç½®application.yamlï¼›
4. å¯åŠ¨rabbitmqï¼Œæ‰§è¡ŒBiInitMainç”Ÿæˆå¯¹åº”é˜Ÿåˆ—ï¼›
5. å¯åŠ¨åç«¯é¡¹ç›®ã€‚

## ä¸»è¦æŠ€æœ¯é€‰å‹

### å‰ç«¯

- React 18.2.0
- Echarts å¯è§†åŒ–åº“ 5.5.0
- Ant Design Pro å¼€å‘è„šæ‰‹æ¶ 3.3.0
- Ant Design ç»„ä»¶åº“ 5.3.3
- Ant Design Pro Components 2.6.48
- UmiJS å‰ç«¯æ¡†æ¶ 4.1.1
- Openapi ç”Ÿæˆå·¥å…· 1.0.1

### åç«¯

- Java 1.8 ï¼ˆå‘ä¸Šå…¼å®¹ï¼‰
- Springboot 2.7.0
- Hutool 5.8.16
- Redisson 3.21.3
- MySQL 8.0.31 ï¼ˆå…¼å®¹5.xç‰ˆæœ¬ï¼‰
- Redis 7.2.0 ï¼ˆå…¼å®¹ä½ç‰ˆæœ¬ï¼‰
- Knife4j 4.0.0
- MongoDB 4.4
- Netty 4.1
- Rabbitmq 3.10
- EasyExcel 3.1.1
- ChatGPT 3.5

## å¼€å‘ç®€ä»‹

### é¡¹ç›®ç»“æ„

![image](https://github.com/polarisronx/Papi-backend/blob/master/doc/images/pabi-architecture.png)

## ä¸»è¦åŠŸèƒ½

### 1 ç™»å½•å’Œæ³¨å†Œ

æ‚¨å¯ä»¥ <a href="https://github.com/polarisronx/pabi-frontend">Pabi æ™ºèƒ½æ•°æ®åˆ†æå¹³å°Â </a> çš„ç™»å½•å’Œæ³¨å†Œé¡µé¢å®Œæˆç™»å½•å’Œæ³¨å†Œï¼Œç›®å‰æ”¯æŒè´¦å·å¯†ç ç™»å½•ã€‚

### 2 åœ¨çº¿åŒæ­¥åˆ†æ

æ‚¨å¯ä»¥ <a href="https://github.com/polarisronx/pabi-frontend">Pabi æ™ºèƒ½æ•°æ®åˆ†æå¹³å° </a> çš„æ™ºèƒ½åœ¨çº¿åˆ†æé¡µé¢æäº¤æ‚¨çš„åˆ†æéœ€æ±‚å’ŒåŸå§‹æ•°æ®ï¼Œåœ¨çº¿ç”Ÿæˆåˆ†æç»“è®ºå’Œå¯è§†åŒ–å›¾è¡¨ã€‚ï¼ˆè§†æœåŠ¡å™¨ç¹å¿™æƒ…å†µç”Ÿæˆè€—æ—¶å¯èƒ½ä¼šæœ‰æ³¢åŠ¨ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼‰

![](https://github.com/polarisronx/Papi-backend/blob/master/doc/images/add.png)

ä½†è¯·æ³¨æ„ï¼šä¸Šä¼ çš„æ¥å£éœ€è¦æ»¡è¶³ä¸€å®šçš„è§„èŒƒï¼Œåœ¨ä¸Šä¼ å‰è¯·åŠ¡å¿…ä»”ç»†é˜…è¯»æ–‡æ¡£ <a href="https://doc.papi.icu">Papi å¼€å‘è€…æ–‡æ¡£</a>

### 3 æ™ºèƒ½å¼‚æ­¥åˆ†æ

æ‚¨å¯ä»¥ <a href="https://github.com/polarisronx/pabi-frontend">Pabi æ™ºèƒ½æ•°æ®åˆ†æå¹³å° </a> çš„æ™ºèƒ½å¼‚æ­¥åˆ†æé¡µé¢æäº¤æ‚¨çš„åˆ†æéœ€æ±‚å’ŒåŸå§‹æ•°æ®ï¼ŒæœåŠ¡ç«¯ä¼šæ ¹æ®ä¸åŒç­–ç•¥å¼‚æ­¥å®Œæˆåˆ†æä»»åŠ¡ï¼Œå¹¶åœ¨å®Œæˆåé€šçŸ¥æ‚¨ã€‚

åœ¨ä½¿ç”¨å‰ç¡®ä¿ä¸åç«¯é€šè®¯æœåŠ¡å™¨è¿æ¥æ­£å¸¸ã€‚

<img src="https://github.com/polarisronx/Papi-backend/blob/master/doc/images/QQ20240707210838.png" style="zoom: 67%;" />

![](https://github.com/polarisronx/Papi-backend/blob/master/doc/images/QQ20240707210947.png)

### 4 å›¾è¡¨ç®¡ç†

- æŸ¥çœ‹å·²ç”Ÿæˆå›¾è¡¨

- ç®¡ç†æœªå®Œæˆå›¾è¡¨


- ç®¡ç†å…¨éƒ¨å›¾è¡¨

### 5 æ¥å£è°ƒç”¨ç»Ÿè®¡åˆ†æ

ç›®å‰åŠŸèƒ½è¿˜æœªå®Œå–„ï¼Œåç»­åä¼šå¯¹æ‰€æœ‰ç”¨æˆ·å¼€æ”¾ã€‚

### 6 ä¸ªæ€§åŒ–è®¾ç½®

ç›®å‰åŠŸèƒ½è¿˜æœªå®Œå–„ï¼Œåç»­åä¼šå¯¹æ‰€æœ‰ç”¨æˆ·å¼€æ”¾ã€‚



### æ‹“å±•1ï¼šåŸºäºNetty-webSocketçš„æ¶ˆæ¯æ¨é€

- #### **V1 é‡‡ç”¨WebSocketçš„å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹**

å‚è€ƒ[SpringBoot2.0é›†æˆWebSocketï¼Œå®ç°åå°å‘å‰ç«¯æ¨é€ä¿¡æ¯_springbooté›†æˆwebsocket-CSDNåšå®¢](https://blog.csdn.net/moshowgame/article/details/80275084?ops_request_misc=%7B%22request%5Fid%22%3A%22164266765516780265476735%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&request_id=164266765516780265476735&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-80275084.pc_search_insert_es_download&utm_term=WebSocket&spm=1018.2226.3001.4187)

> Springå®˜ç½‘å…³äºwebsocketçš„guide
>
> [Getting Started | Using WebSocket to build an interactive web application (spring.io)](https://spring.io/guides/gs/messaging-stomp-websocket)

**1 ä»€ä¹ˆæ˜¯websocketï¼Ÿ**

WebSocketåè®®æ˜¯åŸºäºTCPçš„ä¸€ç§æ–°çš„ç½‘ç»œåè®®ã€‚å®ƒå®ç°äº†æµè§ˆå™¨ä¸æœåŠ¡å™¨å…¨åŒå·¥(full-duplex)é€šä¿¡â€”â€”å…è®¸æœåŠ¡å™¨ä¸»åŠ¨å‘é€ä¿¡æ¯ç»™å®¢æˆ·ç«¯ã€‚éå¸¸é€‚åˆä½œä¸º**æœåŠ¡å™¨æ¨é€**çš„æŠ€æœ¯

**2 ä¸ºä»€ä¹ˆéœ€è¦ WebSocketï¼Ÿ**

HTTP åè®®æœ‰ä¸€ä¸ªç¼ºé™·ï¼š**é€šä¿¡åªèƒ½ç”±å®¢æˆ·ç«¯å‘èµ·**ï¼ŒHTTP åè®®åšä¸åˆ°æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€ä¿¡æ¯ã€‚HTTP åœ¨æ¯æ¬¡è¯·æ±‚ç»“æŸåéƒ½ä¼šä¸»åŠ¨é‡Šæ”¾è¿æ¥ï¼Œå› æ­¤HTTPè¿æ¥æ˜¯ä¸€ç§â€œ**çŸ­è¿æ¥**â€ã€‚è¦ä¿æŒå®¢æˆ·ç«¯ç¨‹åºçš„åœ¨çº¿çŠ¶æ€ï¼Œå°±éœ€è¦å‘æœåŠ¡å™¨è½®è¯¢ï¼Œå³ä¸æ–­åœ°å‘æœåŠ¡å™¨å‘èµ·è¿æ¥è¯·æ±‚ï¼Œä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬æƒ³è¦æŸ¥è¯¢å½“å‰çš„æ’é˜Ÿæƒ…å†µï¼Œåªèƒ½æ˜¯é¡µé¢è½®è¯¢å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›æŸ¥è¯¢ç»“æœã€‚è½®è¯¢çš„æ•ˆç‡ä½ï¼Œéå¸¸æµªè´¹èµ„æºï¼ˆå› ä¸ºå¿…é¡»ä¸åœè¿æ¥ï¼Œæˆ–è€… HTTP è¿æ¥å§‹ç»ˆæ‰“å¼€ï¼‰ã€‚å› æ­¤WebSocket å°±æ˜¯è¿™æ ·å‘æ˜çš„ã€‚

![](https://github.com/polarisronx/Papi-backend/blob/master/doc/images/20180510225115144.png)

**3 WebSocketçš„ç‰¹ç‚¹**

1ï¼‰å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥å»ºç«‹åœ¨ TCP åè®®ä¹‹ä¸Šï¼ŒæœåŠ¡å™¨ç«¯çš„å®ç°æ¯”è¾ƒå®¹æ˜“ã€‚
2ï¼‰ä¸ HTTP åè®®æœ‰ç€è‰¯å¥½çš„å…¼å®¹æ€§ï¼Œæ¡æ‰‹é˜¶æ®µé‡‡ç”¨ HTTP åè®®ã€‚åšä¸€ä¸ªæ¡æ‰‹çš„åŠ¨ä½œæµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´å°±åˆ›å»ºäº†æŒä¹…æ€§çš„è¿æ¥ï¼Œä¸¤è€…ä¹‹é—´å°±ç›´æ¥å¯ä»¥è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“ã€‚
3ï¼‰æ•°æ®æ ¼å¼æ¯”è¾ƒè½»é‡ï¼Œæ€§èƒ½å¼€é”€å°ï¼Œé€šä¿¡é«˜æ•ˆã€‚
4ï¼‰å¯ä»¥å‘é€æ–‡æœ¬ï¼Œä¹Ÿå¯ä»¥å‘é€äºŒè¿›åˆ¶æ•°æ®ã€‚
5ï¼‰æ²¡æœ‰åŒæºé™åˆ¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä¸ä»»æ„æœåŠ¡å™¨é€šä¿¡ã€‚
6ï¼‰åè®®æ ‡è¯†ç¬¦æ˜¯ wsï¼ˆå¦‚æœåŠ å¯†ï¼Œåˆ™ä¸ºwssï¼‰ï¼ŒæœåŠ¡å™¨ç½‘å€å°±æ˜¯ URLã€‚

**4 ä¸å…¶ä»–äº¤äº’æŠ€æœ¯çš„å¯¹æ¯”**

1ï¼‰**Httpè½®è¯¢**
é•¿è½®è¯¢å°±æ˜¯å®¢æˆ·ç«¯æŒ‰ç…§ä¸€ä¸ªå›ºå®šçš„æ—¶é—´å®šæœŸå‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œé€šå¸¸è¿™ä¸ªæ—¶é—´é—´éš”çš„é•¿åº¦å—åˆ°æœåŠ¡ç«¯çš„æ›´æ–°é¢‘ç‡å’Œå®¢æˆ·ç«¯å¤„ç†æ›´æ–°æ•°æ®æ—¶é—´çš„å½±å“ã€‚è¿™ç§æ–¹å¼ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯æµè§ˆå™¨è¦ä¸æ–­å‘è¯·æ±‚åˆ°æœåŠ¡å™¨ä»¥è·å–æœ€æ–°ä¿¡æ¯ï¼Œé€ æˆæœåŠ¡å™¨å‹åŠ›è¿‡å¤§ï¼Œå ç”¨å®½å¸¦èµ„æºã€‚
2ï¼‰**ä½¿ç”¨ streaming AJAX**
streaming ajaxæ˜¯ä¸€ç§é€šè¿‡ ajax å®ç°çš„é•¿è¿æ¥ç»´æŒæœºåˆ¶ã€‚ä¸»è¦ç›®çš„å°±æ˜¯åœ¨æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­å¯¹è¿”å›çš„æ•°æ®è¿›è¡Œè¯»å–ï¼Œå¹¶ä¸”ä¸ä¼šå…³é—­è¿æ¥ã€‚
3ï¼‰**iframeæ–¹å¼**
iframe å¯ä»¥åœ¨é¡µé¢ä¸­åµŒå¥—ä¸€ä¸ªå­é¡µé¢ï¼Œé€šè¿‡å°† iframe çš„ src æŒ‡å‘ä¸€ä¸ªé•¿è¿æ¥çš„è¯·æ±‚åœ°å€ï¼ŒæœåŠ¡ç«¯å°±èƒ½ä¸æ–­å¾€å®¢æˆ·ç«¯ä¼ è¾“æ•°æ®ã€‚

å¾ˆå¤šç½‘ç«™ä¸ºäº†å®ç°æ¨é€æŠ€æœ¯ï¼Œæ‰€ç”¨çš„æŠ€æœ¯éƒ½æ˜¯ Ajax è½®è¯¢ã€‚è½®è¯¢æ˜¯åœ¨ç‰¹å®šçš„çš„æ—¶é—´é—´éš”ï¼ˆå¦‚æ¯1ç§’ï¼‰ï¼Œç”±æµè§ˆå™¨å¯¹æœåŠ¡å™¨å‘å‡º HTTP è¯·æ±‚ï¼Œç„¶åç”±æœåŠ¡å™¨è¿”å›æœ€æ–°çš„æ•°æ®ç»™å®¢æˆ·ç«¯çš„æµè§ˆå™¨ã€‚è¿™ç§ä¼ ç»Ÿçš„æ¨¡å¼å¸¦æ¥å¾ˆæ˜æ˜¾çš„ç¼ºç‚¹ï¼Œå³æµè§ˆå™¨éœ€è¦ä¸æ–­çš„å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œç„¶è€Œ HTTP è¯·æ±‚å¯èƒ½åŒ…å«è¾ƒé•¿çš„å¤´éƒ¨ï¼Œå…¶ä¸­çœŸæ­£æœ‰æ•ˆçš„æ•°æ®å¯èƒ½åªæ˜¯å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¾ç„¶è¿™æ ·ä¼šæµªè´¹å¾ˆå¤šçš„å¸¦å®½ç­‰èµ„æºã€‚

WebSocket ä½¿å¾—å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®äº¤æ¢å˜å¾—æ›´åŠ ç®€å•ï¼Œå…è®¸æœåŠ¡ç«¯ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ã€‚åœ¨ WebSocket API ä¸­ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨åªéœ€è¦å®Œæˆä¸€æ¬¡æ¡æ‰‹ï¼Œä¸¤è€…ä¹‹é—´å°±ç›´æ¥å¯ä»¥åˆ›å»ºæŒä¹…æ€§çš„è¿æ¥ï¼Œå¹¶è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“ã€‚

å‚è€ƒï¼šhttps://blog.csdn.net/IT__learning/article/details/120220624

**4 è½åœ°å®ç°**

**åç«¯ï¼š**

ï¼ˆ1ï¼‰ä¾èµ–åŒ…

Springæä¾›çš„websocketå¯åŠ¨åŒ…

```xml
<dependency>  
    <groupId>org.springframework.boot</groupId>  
    <artifactId>spring-boot-starter-websocket</artifactId>  
</dependency> 
```

ï¼ˆ2ï¼‰é…ç½® Socket

`ServerEndpointExporter` æ˜¯ç”±Springå®˜æ–¹æä¾›çš„æ ‡å‡†å®ç°ï¼Œç”¨äºæ‰«æ`ServerEndpointConfig`é…ç½®ç±»å’Œ@`ServerEndpoint`æ³¨è§£å®ä¾‹ã€‚ä½¿ç”¨è§„åˆ™ä¹Ÿå¾ˆç®€å•ï¼š

```java
@Configuration  
public class WebSocketConfig {  	
    @Bean  
    public ServerEndpointExporter serverEndpointExporter() {  
        return new ServerEndpointExporter();  
    }  
}
```

ï¼ˆ3ï¼‰åç«¯å»ºç«‹Server

```java
@ServerEndpoint("/wsServer/{userId}")
@Component
@Slf4j
public class WebSocketServer {
```

å±æ€§ï¼š

1 OnlineCountï¼šã€é™æ€å˜é‡ã€‘è®°å½•å½“å‰åœ¨çº¿è¿æ¥æ•°ï¼ˆçº¿ç¨‹å®‰å…¨çš„ï¼‰

```java
private static AtomicInteger onlineCount = new AtomicInteger(0);
```

2 webSocketMapï¼šã€é™æ€å˜é‡ã€‘è®°å½•ç”¨æˆ·IDä¸å¯¹åº”çš„å®¢æˆ·ç«¯Socketå¯¹è±¡ï¼ˆçº¿ç¨‹å®‰å…¨çš„ï¼‰

```java
private static ConcurrentHashMap<String,WebSocketServer> webSocketMap = new ConcurrentHashMap<>();
```

3 å…¶ä»–å±æ€§ï¼šsessionã€userIdå»ºç«‹è¿æ¥æ—¶ä¼ å…¥

```java
private Session session;
```

```java
private String userId;
```

æ–¹æ³•ï¼š

```java
/**
* è¿æ¥å»ºç«‹æˆåŠŸè°ƒç”¨çš„æ–¹æ³•
* */
@OnOpen
public void onOpen(Session session,@PathParam("userId") String userId) {
    this.session = session;
    this.userId=userId;
    if(webSocketMap.containsKey(userId)){
        webSocketMap.remove(userId);
        webSocketMap.put(userId,this);
        //åŠ å…¥mapä¸­
    }else{
        webSocketMap.put(userId,this);
        //åŠ å…¥setä¸­
        addOnlineCount();
        //åœ¨çº¿æ•°åŠ 1
    }
    log.info("ç”¨æˆ·è¿æ¥:"+userId+",å½“å‰åœ¨çº¿äººæ•°ä¸º:" + getOnlineCount());

    try {
        sendMessage("è¿æ¥æˆåŠŸ");
    } catch (IOException e) {
        log.error("ç”¨æˆ·:"+userId+",ç½‘ç»œå¼‚å¸¸!!!!!!");
    }
}

/**
* è¿æ¥å…³é—­è°ƒç”¨çš„æ–¹æ³•
*/
@OnClose
public void onClose() {
    if(webSocketMap.containsKey(userId)){
        webSocketMap.remove(userId);
        //ä»setä¸­åˆ é™¤
        subOnlineCount();
    }
    log.info("ç”¨æˆ·é€€å‡º:"+userId+",å½“å‰åœ¨çº¿äººæ•°ä¸º:" + getOnlineCount());
}

/**
* æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯åè°ƒç”¨çš„æ–¹æ³•
*
* @param message å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ¶ˆæ¯*/
@OnMessage
public void onMessage(String message, Session session) {
    log.info("ç”¨æˆ·æ¶ˆæ¯:"+userId+",æŠ¥æ–‡:"+message);
    //å¯ä»¥ç¾¤å‘æ¶ˆæ¯
    //æ¶ˆæ¯ä¿å­˜åˆ°æ•°æ®åº“ã€redis
    if(StringUtils.isNotBlank(message)){
        try {
            //è§£æå‘é€çš„æŠ¥æ–‡
            JSONObject jsonObject = JSON.parseObject(message);
            //è¿½åŠ å‘é€äºº(é˜²æ­¢ä¸²æ”¹)
            jsonObject.put("fromUserId",this.userId);
            String toUserId=jsonObject.getString("toUserId");
            //ä¼ é€ç»™å¯¹åº”toUserIdç”¨æˆ·çš„websocket
            if(StringUtils.isNotBlank(toUserId)&&webSocketMap.containsKey(toUserId)){
                webSocketMap.get(toUserId).sendMessage(jsonObject.toJSONString());
            }else{
                log.error("è¯·æ±‚çš„userId:"+toUserId+"ä¸åœ¨è¯¥æœåŠ¡å™¨ä¸Š");
                //å¦åˆ™ä¸åœ¨è¿™ä¸ªæœåŠ¡å™¨ä¸Šï¼Œå‘é€åˆ°mysqlæˆ–è€…redis
            }
        }catch (Exception e){
            e.printStackTrace();
        }
    }
}

/**
*
* @param session
* @param error
*/
@OnError
public void onError(Session session, Throwable error) {
    log.error("ç”¨æˆ·é”™è¯¯:"+this.userId+",åŸå› :"+error.getMessage());
    error.printStackTrace();
}
/**
* å®ç°æœåŠ¡å™¨ä¸»åŠ¨æ¨é€
*/
public void sendMessage(String message) throws IOException {
    this.session.getBasicRemote().sendText(message);
}

/**
* ç¾¤å‘è‡ªå®šä¹‰æ¶ˆæ¯
*/
public void sendMessage(String message, String userId){
    log.info("æ¨é€æ¶ˆæ¯åˆ°å®¢æˆ·ç«¯ " + userId + "ï¼Œæ¨é€å†…å®¹:" + message);
    try {
        WebSocketServer webSocketServer = webSocketMap.get(userId);
        if (webSocketServer != null) {
            webSocketServer.sendMessage(message);
        } else {
            log.error("è¯·æ±‚çš„userId:" + userId + "ä¸åœ¨è¯¥æœåŠ¡å™¨ä¸Š");
        }
    } catch (IOException e) {
        throw new BusinessException(ErrorCode.SYSTEM_ERROR,"æ¨é€æ¶ˆæ¯å¤±è´¥");
    }
}

/**
* å‘é€è‡ªå®šä¹‰æ¶ˆæ¯
* */
public static void sendInfo(String message,@PathParam("userId") String userId) throws IOException {
    log.info("å‘é€æ¶ˆæ¯åˆ°:"+userId+"ï¼ŒæŠ¥æ–‡:"+message);
    if(StringUtils.isNotBlank(userId)&&webSocketMap.containsKey(userId)){
        webSocketMap.get(userId).sendMessage(message);
    }else{
        log.error("ç”¨æˆ·"+userId+",ä¸åœ¨çº¿ï¼");
    }
}

public static synchronized int getOnlineCount() {
    return onlineCount.get();
}

public static synchronized void addOnlineCount() {
    WebSocketServer.onlineCount.getAndAdd(1);
}

public static synchronized void subOnlineCount() {
    WebSocketServer.onlineCount.getAndAdd(-1);
}
```

å‰ç«¯

Typescript + react

```java
const WebSocketComponent = (userId: any) => {

  useEffect(() => {
    const id = userId.userId;
    console.log(userId)
    // åˆ›å»ºWebSocketè¿æ¥
    // const socket = new WebSocket(`ws://127.0.0.1:6848/api/websocket/\${userId}`);
    const url = 'ws://127.0.0.1:6848/websocket'+id
    console.log(url)
    const socket = new WebSocket(url);
    if(!socket){
        alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebSocketåè®®ï¼");
    }
    // å¤„ç†è¿æ¥æˆåŠŸäº‹ä»¶
    socket.onopen = () => {
      console.log('WebSocketè¿æ¥å·²æ‰“å¼€');
      socket.send('Hello, WebSocket!'); // å‘é€ä¸€æ¡æ¶ˆæ¯
      console.log('å·²å‘é€æ¶ˆæ¯');
    };

    // å¤„ç†æ¥æ”¶åˆ°æ¶ˆæ¯äº‹ä»¶
    socket.onmessage = (event) => {
      const messageContent = event.data;
      console.log('æ”¶åˆ°æ¶ˆæ¯ï¼š', messageContent);
      // ä½¿ç”¨Ant Designçš„messageç»„ä»¶æ˜¾ç¤ºæ¶ˆæ¯
      message.success(messageContent,5);// æ‚¨çš„[]ä¸šåŠ¡å·²å¤„ç†å®Œæ¯•ï¼Œè¯·å‰å¾€[]æŸ¥çœ‹
    };

    // å¤„ç†è¿æ¥å…³é—­äº‹ä»¶
    socket.onclose = () => {
      socket.send('Hello, WebSocket!'); // å‘é€ä¸€æ¡æ¶ˆæ¯
      console.log('å·²å‘é€æ¶ˆæ¯');
      console.log('WebSocketè¿æ¥å·²å…³é—­');
    };

    // å¤„ç†é”™è¯¯äº‹ä»¶
    socket.onerror = (error) => {
      console.error('WebSocketå‘ç”Ÿé”™è¯¯ï¼š', error);
    };

    // åœ¨ç»„ä»¶å¸è½½æ—¶å…³é—­WebSocketè¿æ¥
    return () => {
      socket.close();
    };
  }, [userId]);

  return;
}

export default WebSocketComponent;
```



- #### V2 Netty-WebSocket

> Netty å®˜ç½‘ [Netty: Home](https://netty.io/)

**1 ä»€ä¹ˆæ˜¯Nettyï¼Ÿ**

Netty æ˜¯ç”± JBOSS æä¾›çš„ä¸€ä¸ª Java å¼€æºæ¡†æ¶ã€‚Netty æä¾›å¼‚æ­¥çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œç”¨ä»¥å¿«é€Ÿå¼€å‘é«˜æ€§èƒ½ã€é«˜å¯é æ€§çš„ç½‘ç»œ IO ç¨‹åºï¼Œæ˜¯ç›®å‰æœ€æµè¡Œçš„ NIO æ¡†æ¶ã€‚

**2 ä¸ºä»€ä¹ˆè¦ç”¨Nettyï¼Ÿ**

é¦–å…ˆï¼ŒNettyå¤©ç„¶åœ°æ”¯æŒwebsocketã€‚

1. **é«˜æ€§èƒ½**ï¼šNettyæ˜¯ä¸€ä¸ªä¸“ä¸ºé«˜å¹¶å‘ã€é«˜æ€§èƒ½è®¾è®¡çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶ã€‚å®ƒåˆ©ç”¨éé˜»å¡I/Oå’Œäº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œèƒ½å¤Ÿé«˜æ•ˆåœ°å¤„ç†å¤§é‡å¹¶å‘è¿æ¥ï¼Œè¿™å¯¹äºéœ€è¦ç»´æŒé•¿è¿æ¥çš„WebSocketåº”ç”¨å°¤ä¸ºé‡è¦ã€‚è¿™é€šå¸¸æ„å‘³ç€åœ¨å¤„ç†å¤§é‡å®æ—¶é€šä¿¡æ—¶ï¼ŒNettyå¯ä»¥æä¾›æ›´ä½çš„å»¶è¿Ÿå’Œæ›´é«˜çš„ååé‡ã€‚
2. **å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹**ï¼šNettyçš„å¼‚æ­¥ç‰¹æ€§å…è®¸åœ¨ä¸é˜»å¡çº¿ç¨‹çš„æƒ…å†µä¸‹å¤„ç†ç½‘ç»œäº‹ä»¶ï¼Œè¿™æ„å‘³ç€æœåŠ¡å™¨å¯ä»¥åŒæ—¶å¤„ç†æ›´å¤šçš„è¯·æ±‚ï¼Œè€Œæ— éœ€ä¸ºæ¯ä¸ªè¿æ¥åˆ†é…ç‹¬ç«‹çš„çº¿ç¨‹ï¼Œä»è€Œå‡å°‘äº†èµ„æºæ¶ˆè€—å¹¶æé«˜äº†æ•ˆç‡ã€‚
3. **ç¨³å®šæ€§ä¸æˆç†Ÿåº¦**ï¼šNettyä½œä¸ºä¸€ä¸ªæˆç†Ÿçš„å¼€æºé¡¹ç›®ï¼Œç»è¿‡äº†å¹¿æ³›çš„å®æˆ˜æ£€éªŒï¼Œæ‹¥æœ‰æ´»è·ƒçš„ç¤¾åŒºæ”¯æŒå’ŒæŒç»­çš„æ›´æ–°ç»´æŠ¤ã€‚å®ƒè§£å†³äº†è®¸å¤šåº•å±‚ç½‘ç»œç¼–ç¨‹ä¸­çš„å¸¸è§é—®é¢˜ï¼Œå¦‚å†…å­˜ç®¡ç†ã€çº¿ç¨‹æ¨¡å‹ä¼˜åŒ–ç­‰ï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥æ›´ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘è€ŒéåŸºç¡€æ¶æ„é—®é¢˜ã€‚
4. **ç®€åŒ–å¼€å‘å¤æ‚åº¦**ï¼šç›¸æ¯”åŸç”ŸWebSocketå®ç°ï¼ŒNettyæä¾›äº†æ›´é«˜çº§åˆ«çš„æŠ½è±¡ï¼Œä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿä»¥æ›´ç®€æ´çš„ä»£ç å®ç°å¤æ‚çš„ç½‘ç»œé€šä¿¡åŠŸèƒ½ã€‚APIçš„è®¾è®¡å€¾å‘äºç®€æ´æ˜“ç”¨ï¼Œé™ä½äº†å¼€å‘é—¨æ§›ã€‚

**3 è½åœ°å®ç°**

åç«¯ï¼šï¼ˆJavaï¼‰

ï¼ˆ1ï¼‰å¼•å…¥ä¾èµ–

```xml
<!-- https://mvnrepository.com/artifact/io.netty/netty-all -->
<dependency>
    <groupId>io.netty</groupId>
    <artifactId>netty-all</artifactId>
    <version>4.1.100.Final</version>
</dependency>
```

ï¼ˆ2ï¼‰åˆ›å»ºNettyæœåŠ¡ç«¯ç±»NettyServer

è®©Springæ¥ç®¡ç†

```java
@Configuration
@Slf4j
@Data
public class NettyServer {
    ...
}
```

å±æ€§ï¼š

```java
@Value("${netty-server.port}")
private int port;// nettyæœåŠ¡å™¨çš„ç«¯å£å¯ä»¥è‡ªå·±æŒ‡å®š
private ChannelFuture channelFuture;// ç”¨äºå¼‚æ­¥ç®¡ç†NettyæœåŠ¡å™¨çš„channel
//è´Ÿè´£å¤„ç†æ¥å—è¿›æ¥çš„é“¾æ¥
private EventLoopGroup bossGroup;
//è´Ÿè´£å¤„ç†å·²ç»è¢«æ¥æ”¶çš„è¿æ¥ä¸Šçš„I/Oæ“ä½œ
private EventLoopGroup workerGroup;
@Resource
private ThreadPoolExecutor threadPoolExecutor;// çº¿ç¨‹æ± ï¼Œåé¢è¯´æ˜
```

æ–¹æ³•ï¼š

```java
@Async("threadPoolExecutor")// å®ç°çº¿ç¨‹æ± ï¼Œè®©è¿™ä¸ªæ–¹æ³•å¼‚æ­¥æ‰§è¡Œ
public void start() throws Exception {
    bossGroup = new NioEventLoopGroup();
    workerGroup = new NioEventLoopGroup();
    try {
        ServerBootstrap sb = new ServerBootstrap();
        sb.option(ChannelOption.SO_BACKLOG, 1024);
        sb.group(bossGroup, workerGroup) // ç»‘å®šçº¿ç¨‹æ± 
            .channel(NioServerSocketChannel.class) // æŒ‡å®šä½¿ç”¨çš„channel
            .localAddress(this.port)// ç»‘å®šç›‘å¬ç«¯å£
            .childHandler(new ChannelInitializer<SocketChannel>() { // ç»‘å®šå®¢æˆ·ç«¯è¿æ¥æ—¶å€™è§¦å‘æ“ä½œ

                @Override
                protected void initChannel(SocketChannel ch) {
                    log.info("æ”¶åˆ°æ–°è¿æ¥");
                    //websocketåè®®æœ¬èº«æ˜¯åŸºäºhttpåè®®çš„ï¼Œæ‰€ä»¥è¿™è¾¹ä¹Ÿè¦ä½¿ç”¨httpè§£ç¼–ç å™¨
                    ch.pipeline().addLast(new HttpServerCodec());
                    //ä»¥å—çš„æ–¹å¼æ¥å†™çš„å¤„ç†å™¨
                    ch.pipeline().addLast(new ChunkedWriteHandler());
                    ch.pipeline().addLast(new HttpObjectAggregator(8192));
                    ch.pipeline().addLast(new MyWebSocketHandler());
                    ch.pipeline().addLast(new WebSocketServerProtocolHandler("/websocket", null, true, 65536 * 10));
					// å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡ç«¯çš„åœ°å€ï¼šip:port/websocket
                }
            });
        channelFuture = sb.bind().sync(); // æœåŠ¡å™¨å¼‚æ­¥åˆ›å»ºç»‘å®š
        log.info(NettyServer.class + " å¯åŠ¨æ­£åœ¨ç›‘å¬ï¼š " + channelFuture.channel().localAddress());
        channelFuture.channel().closeFuture().sync(); // å…³é—­æœåŠ¡å™¨é€šé“
    } finally {
        workerGroup.shutdownGracefully().sync(); // é‡Šæ”¾çº¿ç¨‹æ± èµ„æº
        bossGroup.shutdownGracefully().sync();
    }
}
@PreDestroy // Serverå®ä¾‹è¢«é”€æ¯æ—¶æ‰§è¡Œçš„æ–¹æ³•ï¼Œä¸»è¦æ˜¯å…³é—­èµ„æº
public void stopServer(){
    if (channelFuture != null && !channelFuture.isDone()) {
        channelFuture.cancel(true);
    }
    workerGroup.shutdownGracefully();
    bossGroup.shutdownGracefully();
}
```

ï¼ˆ3ï¼‰å®šä¹‰channelGroup

ç”¨æ¥ç®¡ç†ç›®å‰æ‰€æœ‰å·²è¿æ¥çš„channel

```java
public class ChannelHandlerPool {
    public ChannelHandlerPool(){}
    public static ChannelGroup channelGroup = new DefaultChannelGroup(GlobalEventExecutor.INSTANCE);
}
```

ï¼ˆ4ï¼‰å®šä¹‰MyWebSocketHandlerç±»

è¿™ä¸ªç±»ç”¨äºå¤„ç†è¿æ¥å¼€å¯ã€å…³é—­ã€å‘é€æ¶ˆæ¯ç­‰æ“ä½œï¼Œç±»ä¼¼äºcontrollerã€‚

```java
@Slf4j
public class MyWebSocketHandler extends SimpleChannelInboundHandler<TextWebSocketFrame> {

	// ç”¨äºç»‘å®šchannelå’Œç”¨æˆ·çš„ID
    public static final Map<String, ChannelHandlerContext> webSocketMap = new ConcurrentHashMap<>();

    @Override
    public void channelActive(ChannelHandlerContext ctx) throws Exception {
        log.info("ä¸å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ï¼Œé€šé“å¼€å¯ï¼");

        //æ·»åŠ åˆ°channelGroupé€šé“ç»„
        ChannelHandlerPool.channelGroup.add(ctx.channel());
    }

    @Override
    public void channelInactive(ChannelHandlerContext ctx) throws Exception {
        log.info("ä¸å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼Œé€šé“å…³é—­ï¼");
        //æ·»åŠ åˆ°channelGroup é€šé“ç»„
        ChannelHandlerPool.channelGroup.remove(ctx.channel());
    }

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
        //é¦–æ¬¡è¿æ¥æ˜¯FullHttpRequestï¼Œå¤„ç†å‚æ•°
        if (msg instanceof FullHttpRequest) {
            FullHttpRequest request = (FullHttpRequest) msg;
            String uri = request.uri();

            Map paramMap=getUrlParams(uri);
            webSocketMap.put(paramMap.get("id").toString(),ctx);
            log.info("æ¥æ”¶åˆ°çš„å‚æ•°æ˜¯ï¼š" + JSON.toJSONString(paramMap));

            //å¦‚æœurlåŒ…å«å‚æ•°ï¼Œéœ€è¦å¤„ç†
            if(uri.contains("?")){
                String newUri=uri.substring(0,uri.indexOf("?"));
                log.info(newUri);
                request.setUri(newUri);
            }

        }else if(msg instanceof TextWebSocketFrame){
            //æ­£å¸¸çš„TEXTæ¶ˆæ¯ç±»å‹
            TextWebSocketFrame frame=(TextWebSocketFrame)msg;
            log.info("å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨æ•°æ®ï¼š" +frame.text());
//            sendAllMessage(frame.text());
            ctx.writeAndFlush(new TextWebSocketFrame("Hello,ä¸æœåŠ¡å™¨çš„è¿æ¥å·²å»ºç«‹ï¼"));
        }
        super.channelRead(ctx, msg);
    }

    @Override
    protected void channelRead0(ChannelHandlerContext channelHandlerContext, TextWebSocketFrame textWebSocketFrame) throws Exception {

    }

    private void sendAllMessage(String message){
        //æ”¶åˆ°ä¿¡æ¯åï¼Œç¾¤å‘ç»™æ‰€æœ‰channel
        ChannelHandlerPool.channelGroup.writeAndFlush( new TextWebSocketFrame(message));
    }

    public static void sendMessage(String id,String message){
        ChannelHandlerContext ctx = webSocketMap.get(id);
        if (ctx != null) {
            log.info("å‘é€ç»™å®¢æˆ·ç«¯æ¶ˆæ¯ï¼š" + message);
            ctx.channel().writeAndFlush(new TextWebSocketFrame(message));
        }
    }

    private static Map getUrlParams(String url){
        Map<String,String> map = new HashMap<>();
        url = url.replace("?",";");
        if (!url.contains(";")){
            return map;
        }
        if (url.split(";").length > 0){
            String[] arr = url.split(";")[1].split("&");
            for (String s : arr){
                String key = s.split("=")[0];
                String value = s.split("=")[1];
                map.put(key,value);
            }
            return  map;

        }else{
            return map;
        }
    }
}
```

å‰ç«¯ï¼š

```java
const WebSocketComponent = (userId: any) => {

  useEffect(() => {
    const id = userId.userId;
    console.log(userId)
    // åˆ›å»ºWebSocketè¿æ¥
    const url = 'ws://127.0.0.1:6848/websocket?id='+id
    console.log(url)
    const socket = new WebSocket(url);
    if(!socket){
        alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebSocketåè®®ï¼");
    }
    // å¤„ç†è¿æ¥æˆåŠŸäº‹ä»¶
    socket.onopen = () => {
      console.log('WebSocketè¿æ¥å·²æ‰“å¼€');
      socket.send('Hello, WebSocket!'); // å‘é€ä¸€æ¡æ¶ˆæ¯
      console.log('å·²å‘é€æ¶ˆæ¯');
    };

    // å¤„ç†æ¥æ”¶åˆ°æ¶ˆæ¯äº‹ä»¶
    socket.onmessage = (event) => {
      const messageContent = event.data;
      console.log('æ”¶åˆ°æ¶ˆæ¯ï¼š', messageContent);
      // ä½¿ç”¨Ant Designçš„messageç»„ä»¶æ˜¾ç¤ºæ¶ˆæ¯
      message.success(messageContent,5)
      // æ‚¨çš„[]ä¸šåŠ¡å·²å¤„ç†å®Œæ¯•ï¼Œè¯·å‰å¾€[]æŸ¥çœ‹
    };

    // å¤„ç†è¿æ¥å…³é—­äº‹ä»¶
    socket.onclose = () => {
      socket.send('Hello, WebSocket!'); // å‘é€ä¸€æ¡æ¶ˆæ¯
      console.log('å·²å‘é€æ¶ˆæ¯');
      console.log('WebSocketè¿æ¥å·²å…³é—­');
    };

    // å¤„ç†é”™è¯¯äº‹ä»¶
    socket.onerror = (error) => {
      console.error('WebSocketå‘ç”Ÿé”™è¯¯ï¼š', error);
    };

    // åœ¨ç»„ä»¶å¸è½½æ—¶å…³é—­WebSocketè¿æ¥
    return () => {
      socket.close();
    };
  }, [userId]);

  return;
}

export default WebSocketComponent;
```

**4 ä¸€äº›ç»†èŠ‚**

ï¼ˆ1ï¼‰å®¢æˆ·ç«¯è¿æ¥ä¼šè®°å½•å®¢æˆ·ç«¯ipã€è¿æ¥çš„channelä¿¡æ¯ï¼Œä½†è¿™äº›ä¸ä¸šåŠ¡æ— å…³ï¼Œæˆ‘ä»¬çœŸæ­£éœ€è¦çš„æ˜¯çŸ¥é“ç”¨æˆ·æ˜¯è°ï¼Œå³ç”¨æˆ·IDã€‚

æ‰€ä»¥å‰ç«¯åœ¨å‘èµ·è¯·æ±‚æ—¶ï¼Œéœ€è¦æºå¸¦è¯·æ±‚å‚æ•°idï¼Œåç«¯æ¥æ”¶æ—¶MyWebSocketHandlerä¼šæŠŠç”¨æˆ·IDå’Œchannelç”¨Mapç»‘å®šï¼Œåé¢æœåŠ¡å™¨æ¨é€æ¶ˆæ¯å¯ä»¥ç”¨IDç›´æ¥æ‰¾åˆ°å¯¹åº”çš„channelã€‚

ï¼ˆ2ï¼‰NettyServerå¯åŠ¨ç›‘å¬å®¢æˆ·ç«¯è¿æ¥ä¼šé˜»å¡Springbooté¡¹ç›®çš„å…¶ä»–ä¸šåŠ¡ï¼Œæ‰€ä»¥åº”è¯¥ç”¨çº¿ç¨‹æ± è®©Nettyå¼‚æ­¥å¯åŠ¨ã€‚

åœ¨springbootçš„ä¸»å¯åŠ¨ç±»

```java
@SpringBootApplication(exclude = {RedisAutoConfiguration.class})
@MapperScan("com.polaris.project.mapper")
@EnableScheduling
@EnableAspectJAutoProxy(proxyTargetClass = true, exposeProxy = true)
@EnableAsync
public class MainApplication implements ApplicationRunner {
    @Resource
    private NettyServer nettyServer;
    public static void main(String[] args) {
        SpringApplication.run(MainApplication.class, args);
    }

    @Override
    public void run (ApplicationArguments args) throws Exception{
        Log.info("Netty Server started on port: {}", String.valueOf(nettyServer.getPort()));
        nettyServer.start();
    }
}
```

å‰é¢å·²ç»åœ¨start()åŠ äº†@Asyncã€‚

ï¼ˆ3ï¼‰å…³äºNettyå¿ƒè·³ä¿æ´»

åœ¨serveræ·»åŠ ç©ºé—²çŠ¶æ€å¤„ç†å™¨

```java
// è¿™é‡Œè®¾ç½®5ç§’å†…æ²¡æœ‰ä» Channel è¯»å†™æ•°æ®æ—¶ä¼šè§¦å‘ä¸€ä¸ª READER_IDLE äº‹ä»¶ã€‚
ch.pipeline().addLast(new IdleStateHandler(5, 0, 0, TimeUnit.SECONDS));
```

å¯ä»¥å‚è€ƒ[Netty å¿ƒè·³æœºåˆ¶è¯¦è§£_nettyå¿ƒè·³æœºåˆ¶-CSDNåšå®¢](https://blog.csdn.net/qq_33807380/article/details/134044727)

å‚è€ƒï¼š

[SpringBoot2+Netty+WebSocket(nettyå®ç°websocketï¼Œæ”¯æŒURLå‚æ•°)_netty websocket åŠ urlå‚æ•°-CSDNåšå®¢](https://zhengkai.blog.csdn.net/article/details/91552993)

[ä½¿ç”¨springBootåˆå§‹åŒ–å¯åŠ¨nettyåˆ›å»ºçš„ä¸¤ä¸ªæœåŠ¡ï¼Œè§£å†³åªèƒ½å¯åŠ¨ä¸€ä¸ªï¼Œå¦ä¸€ä¸ªä¸èƒ½æ‰§è¡Œé—®é¢˜_springboot å¤šæ¨¡å—é¡¹ç›® ä¸€ä¸ªèƒ½å¯åŠ¨,ä¸€ä¸ªä¸èƒ½å¯åŠ¨-CSDNåšå®¢](https://blog.csdn.net/ddd295569371/article/details/127015451)

[SpringBootæ•´åˆNetty(æœåŠ¡ç«¯)_springboot netty-CSDNåšå®¢](https://blog.csdn.net/m0_70554089/article/details/138992105)

![](https://github.com/polarisronx/Papi-backend/blob/master/doc/images/QQ20240707210838.png)

![](https://github.com/polarisronx/Papi-backend/blob/master/doc/images/QQ20240707210947.png)

- #### V3 åˆ†å¸ƒå¼WebSocket TODO

åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å®ç°WebSocketçš„æŒ‘æˆ˜ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ï¼š

1. ä¼šè¯å…±äº«ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·çš„WebSocketè¿æ¥å¯èƒ½ä¸ä¸åŒçš„æœåŠ¡å™¨å»ºç«‹ï¼Œè¿™å°±è¦æ±‚ç³»ç»Ÿèƒ½å¤Ÿåœ¨ä¸åŒæœåŠ¡å™¨é—´å…±äº«WebSocketä¼šè¯ä¿¡æ¯ï¼Œä»¥ä¾¿æ¶ˆæ¯èƒ½å¤Ÿè¢«æ­£ç¡®åœ°ä¼ é€’åˆ°æ‰€æœ‰ç›¸å…³çš„å®¢æˆ·ç«¯ã€‚
2. è´Ÿè½½å‡è¡¡ï¼šä½¿ç”¨è´Ÿè½½å‡è¡¡å¯ä»¥æé«˜ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œä¼¸ç¼©æ€§ã€‚ä½†æ˜¯ï¼Œå½“WebSocketè¯·æ±‚åœ¨æœåŠ¡å™¨ä¹‹é—´è´Ÿè½½å‡è¡¡æ—¶ï¼Œéœ€è¦ç¡®ä¿å®¢æˆ·ç«¯å¯ä»¥ä¸æ­£ç¡®çš„æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ¥æ”¶åˆ°æ‰€æœ‰çš„æ¶ˆæ¯ã€‚
3. æ•…éšœè½¬ç§»ï¼šåœ¨å‡ºç°æœåŠ¡å™¨æ•…éšœæ—¶ï¼Œç³»ç»Ÿéœ€è¦èƒ½å¤Ÿå°†WebSocketä¼šè¯æ— ç¼è¿ç§»åˆ°å…¶ä»–å¥åº·çš„æœåŠ¡å™¨ä¸Šï¼Œä»¥ä¿è¯æœåŠ¡çš„è¿ç»­æ€§ã€‚
4. ä¸€è‡´æ€§ï¼šç¡®ä¿æ‰€æœ‰ç”¨æˆ·åœ¨ä»»ä½•æ—¶å€™çœ‹åˆ°çš„éƒ½æ˜¯ä¸€è‡´çš„æ¶ˆæ¯çŠ¶æ€ï¼Œè¿™å¯¹äºå®æ—¶é€šä¿¡éå¸¸é‡è¦ã€‚

ä¸ºäº†è§£å†³è¿™äº›æŒ‘æˆ˜ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹å‡ ç§ç­–ç•¥ï¼š

1. ä½¿ç”¨æ¶ˆæ¯ä»£ç†ï¼šé€šè¿‡å¼•å…¥ä¸€ä¸ªä¸­å¿ƒåŒ–çš„æ¶ˆæ¯ä»£ç†ï¼ˆå¦‚RabbitMQã€Redis Pub/Subç­‰ï¼‰ï¼Œå¯ä»¥è®©æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½è¿æ¥åˆ°è¿™ä¸ªæ¶ˆæ¯ä»£ç†ã€‚å½“ä¸€ä¸ªæœåŠ¡å™¨éœ€è¦å‘é€æ¶ˆæ¯æ—¶ï¼Œå®ƒå°†æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯ä»£ç†ï¼Œç„¶åç”±æ¶ˆæ¯ä»£ç†è´Ÿè´£å°†æ¶ˆæ¯åˆ†å‘åˆ°æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿æ¶ˆæ¯çš„ä¸€è‡´æ€§å’Œå¯é æ€§ã€‚
2. å…±äº«ä¼šè¯å­˜å‚¨ï¼šä½¿ç”¨ä¸€ä¸ªå…±äº«çš„ä¼šè¯å­˜å‚¨ï¼ˆå¦‚æ•°æ®åº“æˆ–å†…å­˜æ•°æ®ç½‘æ ¼ï¼‰æ¥ä¿å­˜WebSocketä¼šè¯çš„çŠ¶æ€ã€‚è¿™æ ·ï¼Œå³ä½¿å®¢æˆ·ç«¯æœ€åˆè¿æ¥åˆ°çš„æœåŠ¡å™¨å‘ç”Ÿæ•…éšœï¼Œå…¶ä»–æœåŠ¡å™¨ä¹Ÿå¯ä»¥æ¥ç®¡ä¼šè¯å¹¶ç»§ç»­å¤„ç†æ¶ˆæ¯ã€‚
3. åŸºäºè·¯ç”±çš„è´Ÿè½½å‡è¡¡ï¼šä½¿ç”¨æ™ºèƒ½è´Ÿè½½å‡è¡¡å™¨ï¼ˆå¦‚Nginxã€HAProxyç­‰ï¼‰ï¼Œå®ƒä»¬å¯ä»¥æ ¹æ®ç‰¹å®šçš„è·¯ç”±è§„åˆ™ï¼ˆå¦‚ä¼šè¯IDæˆ–ç”¨æˆ·IDï¼‰å°†WebSocketè¿æ¥å®šå‘åˆ°ç‰¹å®šçš„æœåŠ¡å™¨ã€‚
4. æœåŠ¡å‘ç°ï¼šåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå¯ä»¥ä½¿ç”¨æœåŠ¡å‘ç°æœºåˆ¶æ¥åŠ¨æ€åœ°æ‰¾åˆ°è´Ÿè´£ç‰¹å®šä¼šè¯çš„æœåŠ¡å™¨ï¼Œå¹¶å°†æ¶ˆæ¯è·¯ç”±åˆ°é‚£é‡Œã€‚
5. WebSocketä»£ç†ï¼šä½¿ç”¨ä¸“é—¨çš„WebSocketä»£ç†æœåŠ¡å™¨ï¼Œå®ƒå¯ä»¥åœ¨å¤šä¸ªåç«¯æœåŠ¡å™¨ä¹‹é—´ä»£ç†WebSocketè¿æ¥ï¼Œå¹¶ç¡®ä¿æ¶ˆæ¯çš„ä¼ é€’å’Œä¼šè¯çš„åŒæ­¥ã€‚
6. åº”ç”¨å±‚åè®®ï¼šè®¾è®¡åº”ç”¨å±‚åè®®æ¥å¤„ç†åˆ†å¸ƒå¼WebSocketçš„å¤æ‚æ€§ï¼Œä¾‹å¦‚é€šè¿‡å¼•å…¥å¿ƒè·³æœºåˆ¶æ¥æ£€æµ‹è¿æ¥çš„å¥åº·çŠ¶å†µï¼Œå¹¶é€šè¿‡é¢„å®šçš„åè®®æ¥åŒæ­¥ä¼šè¯çŠ¶æ€ã€‚

å‚è€ƒï¼š[SpringBoot+Rediså®ç°åˆ†å¸ƒå¼WebSocket_åˆ†å¸ƒå¼websocketå®ç°æ–¹æ¡ˆ-CSDNåšå®¢](https://blog.csdn.net/moshowgame/article/details/136826457)

### æ‹“å±•2ï¼šAOP+è‡ªå®šä¹‰æ³¨è§£+Redissonæ¶æ„è¯·æ±‚æ‹¦æˆª

æ¶æ„è¯·æ±‚å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿèµ„æºçš„æåº¦æµªè´¹ï¼Œç”šè‡³é€ æˆç³»ç»Ÿå´©æºƒæˆ–æœåŠ¡æ‹’ç»ã€‚

> #### **1 é¢„é˜²æªæ–½**

**ä»å‰ç«¯å¼€å§‹é¢„é˜²**

æ€ç»´Aï¼šç¡®å®æ˜¯ä¸€ç§åŠæ³•ï¼Œç»™å‰ç«¯ â• éªŒè¯ç ã€çŸ­ä¿¡éªŒè¯ï¼Œæˆ–è€…åŠ ä¸Šè°·æ­Œè®¤è¯ï¼ˆç”¨æˆ·è¯´ï¼šæˆ‘è°¢è°¢ä½ å“ˆï¼Œæ¶ˆé˜²æ “ï¼‰ã€‚

æ€ç»´Bï¼šå†æ¬¡æ€è€ƒä¸‹è¿˜æ˜¯ç®—äº†ï¼Œè¿™æ¬¡ä¸æƒ³åŠ¨æˆ‘çš„å‰ç«¯åŠ ä¸Šå¦‚ä½•çŸ­ä¿¡éªŒè¯è¿˜æ¶ˆè€—æˆ‘çš„ğŸ’´ï¼Œæœ¬æ¥å°±æ˜¯ä¸€ä¸ªç»ƒæ‰‹é¡¹ç›®ï¼Œæ‰“ä½âŒã€‚

**äººå·¥å¹²é¢„**

æ€ç»´Aï¼šå“‡ï¼äººå·¥å¹²é¢„å¾ˆç´¯çš„æ¬¸ï¼Œæ‹œæ‰˜ã€‚

æ€ç»´Bï¼šé‚£å¦‚æœæ˜¯å®šæ—¶äººå·¥æ£€æŸ¥è¿›è¡Œå¹²é¢„å¤„ç†ï¼Œè¾…åŠ©å…¶ä»–æ£€æµ‹æ‰‹æ®µå‘¢ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰è¿˜è¡Œï¼

**ä½¿ç”¨ç½‘å…³ç»™ä»–é¢„é˜²**

æ€ç»´Aï¼šç½‘å…³ï¼å¥½åƒå¬èµ·æ¥ä¸é”™ã€‚

æ€ç»´Bï¼šä¸è¡Œï¼æˆ‘é¡¹ç›®éƒ½æ²¡æœ‰ç½‘å…³ï¼Œå•å•ä¸ºäº†é»‘å­å¢åŠ ä¸€ä¸ªç½‘å…³ï¼Œå¦å†³âŒã€‚

**æ—¥å¿—ç›‘æ§**

æ€ç»´Aï¼šæ—¥å¿—ç›‘æ§å¥½åƒè¿˜ä¸é”™æ¬¸ï¼Œå¯ä»¥è®©ç³»ç»Ÿæ—¥å¿—çš„è¾“å‡ºåˆ°æ—¶å€™ç»Ÿä¸€ç›‘æ§ï¼Œç„¶åå‘çŸ­ä¿¡å‘Šè¯‰æˆ‘ä»¬ã€‚

æ€ç»´Bï¼šæ—¥å¿—ç›‘æ§ç¡®å®å¯ä»¥ï¼Œå‘çŸ­ä¿¡è¿˜æ˜¯ç®—äº†ï¼Œæ‹’ç»ä¸€åˆ‡èŠ±é”€å“ˆâŒã€‚

**åç«¯ AOP è‡ªåŠ¨æ£€æµ‹**

æ€ç»´Aï¼šæˆ‘æƒ³åˆ°äº†ï¼åç«¯ AOP æ‹¦æˆªè®¿é—®é™æµï¼Œé€šè¿‡è‡ªåŠ¨æ£€æµ‹å°† IP + ç”¨æˆ·ID åŠ å…¥é»‘åå•ï¼Œè®©é»‘å­æ— æ‰€éå½¢ã€‚æˆ‘è§‰å¾—å¯ä»¥æˆ‘ä»¬æ¥è¯•è¯•ï¼Ÿ

æ€ç»´Bï¼šè¿˜ç­‰ä»€ä¹ˆï¼æ¥è¯•è¯•å§ï¼

> #### 2 å®ç°æ–¹æ¡ˆ

**è‡ªå®šä¹‰æ³¨è§£**

1ï¼‰è·å–æ‹¦æˆªå¯¹è±¡çš„æ ‡è¯† keyï¼Œè®¾ä¸ºç”¨æˆ·çš„è´¦æˆ· userAccountå’ŒIPã€‚

2ï¼‰é™åˆ¶é¢‘ç‡ rageLimitï¼Œå¦‚æœæ¯ç§’è¶…è¿‡ 10 æ¬¡å°±ç›´æ¥å°ç¦ã€‚

3ï¼‰åŠ å…¥é»‘åå• protectLimitï¼Œè®¾ä¸º1ï¼Œè¶…è¿‡1æ¬¡é™é¢‘å°±åŠ å…¥é»‘åå•ã€‚

4ï¼‰è·å–åé¢å›è°ƒçš„æ–¹æ³•ï¼Œä¼šç”¨åå°„æ¥å®ç°æ¥å£çš„è°ƒç”¨ï¼Œè¿”å›ç™»å½•å¤±è´¥ã€‚

**åˆ‡é¢ç±»**

1. ä»RequestContextHolderè·å–è¯·æ±‚çš„è¿œç¨‹IPï¼Œä»æ¥å…¥ç‚¹jointpointè·å–userAccountä½œä¸ºå°ç¦çš„key
2. åˆ©ç”¨redissonè·å–é™æµå¯¹è±¡rateLimiterï¼Œæ¯ç§’é¢å‘10ä¸ªä»¤ç‰Œ
3. å·²åœ¨é»‘åå•ç”¨æˆ·ç›´æ¥å¿«é€Ÿå¤±è´¥
4. è®¿é—®é¢‘æ¬¡æ­£å¸¸çš„ç”¨æˆ·æ­£å¸¸è®¿é—®ï¼Œè¶…è¿‡é™å®šé¢‘æ¬¡çš„ç”¨æˆ·å¿«é€Ÿå¤±è´¥å¹¶åŠ å…¥é»‘åå•ã€‚

```java
@Aspect
@Component
@Slf4j
public class RageLimitInterceptor {
    private final RedissonClient redissonClient;

    private RMapCache<String, Long> blacklist;

    // ç”¨æ¥å­˜å‚¨ç”¨æˆ·IDä¸å¯¹åº”çš„RateLimiterå¯¹è±¡
    private final Cache<String, RRateLimiter> userRateLimiters = CacheBuilder.newBuilder()
            .expireAfterWrite(1, TimeUnit.MINUTES)
            .build();

    public RageLimitInterceptor(RedissonClient redissonClient) {
        this.redissonClient = redissonClient;
        if (redissonClient != null) {
            log.info("Redisson object is not null, using Redisson...");
            // ä½¿ç”¨ Redisson å¯¹è±¡æ‰§è¡Œç›¸å…³æ“ä½œ
            // ä¸ªäººé™é¢‘é»‘åå•24h
            blacklist = redissonClient.getMapCache("blacklist");
            blacklist.expire(24, TimeUnit.HOURS);// è®¾ç½®è¿‡æœŸæ—¶é—´
        } else {
            log.error("Redisson object is null!");
        }
    }

    /**
     * @Description é‡ç”¨åˆ‡å…¥ç‚¹ï¼šæ³¨è§£æ ‡æ³¨è¿‡çš„åœ°æ–¹
     * @author polaris
     * @create 2024/6/10
     */
    @Pointcut("@annotation(com.polaris.project.annotation.BlackListInterceptor)")
    public void aopPoint() {
    }

    /**
     * @Description æ‹¦æˆªè¯·æ±‚ï¼Œè¿›è¡Œé™æµå¤„ç†
     * å¯¹ç”¨æˆ·çš„userAccountä½œä¸ºkeyé™æµï¼Œè¶…è¿‡10æ¬¡æ¯ç§’é™æµåŠ å…¥é»‘åå•ï¼ˆ24å°æ—¶ï¼‰ï¼Œé»‘åå•å†…ç”¨æˆ·æ‹’ç»è¯·æ±‚å¿«é€Ÿå¤±è´¥
     * @author polaris
     * @create 2024/6/10
     * @return {@link Object}
     */
    @Around("aopPoint() && @annotation(blacklistInterceptor)")
    public Object doRouter(ProceedingJoinPoint jp, BlackListInterceptor blacklistInterceptor) throws Throwable {
        String key = blacklistInterceptor.key();

        // è·å–è¯·æ±‚å±æ€§
        RequestAttributes requestAttributes = RequestContextHolder.currentRequestAttributes();
        HttpServletRequest httpServletRequest = ((ServletRequestAttributes) requestAttributes).getRequest();
        //è·å– IP
        String remoteHost = httpServletRequest.getRemoteHost();
        if (StringUtils.isBlank(key)) {
            throw new BusinessException(ErrorCode.NO_AUTH_ERROR, "æ‹¦æˆªçš„ key ä¸èƒ½ä¸ºç©º");
        }

        // è·å–æ‹¦æˆªå­—æ®µ
        String keyAttr;
        if (key.equals("default")) {
            keyAttr = StpUtil.getLoginId().toString();
        } else {
            keyAttr = getAttrValue(key, jp.getArgs()).getBytes(StandardCharsets.UTF_8).toString();
        }
        keyAttr=LIMIT_PREFIX + blacklistInterceptor.business() + ":" + keyAttr;
        log.info("aop attr {}", keyAttr);

        // é»‘åå•æ‹¦æˆª
        if (blacklistInterceptor.protectLimit() != 0 && null != blacklist.getOrDefault(keyAttr, null) && (blacklist.getOrDefault(keyAttr, 0L) > blacklistInterceptor.protectLimit()
                ||blacklist.getOrDefault(remoteHost, 0L) > blacklistInterceptor.protectLimit())) {
            log.info("æœ‰å°é»‘å­è¢«æˆ‘æŠ“ä½äº†ï¼ç»™ä»– 24 å°æ—¶å°ç¦å¥—é¤å§ï¼š{}", keyAttr);
            return fallbackMethodResult(jp, blacklistInterceptor.fallbackMethod());
        }

        // è·å–é™æµ
        RRateLimiter rateLimiter;
        if (!userRateLimiters.asMap().containsKey(keyAttr)) {
            rateLimiter = redissonClient.getRateLimiter(keyAttr);
            // è®¾ç½®RateLimiterçš„é€Ÿç‡ï¼Œæ¯ç§’å‘æ”¾10ä¸ªä»¤ç‰Œ
            rateLimiter.trySetRate(RateType.OVERALL, blacklistInterceptor.rageLimit(), 1, RateIntervalUnit.SECONDS);
            userRateLimiters.put(keyAttr, rateLimiter);
        } else {
            rateLimiter = userRateLimiters.getIfPresent(keyAttr);
        }

        // é™æµæ‹¦æˆª
        if (rateLimiter != null && !rateLimiter.tryAcquire()) {
            if (blacklistInterceptor.protectLimit() != 0) {
                //å°æ ‡è¯†
                long keys = blacklist.getOrDefault(keyAttr, 0L) + 1L;
                blacklist.put(keyAttr,keys);
                //å° IP
                long ips = blacklist.getOrDefault(remoteHost, 0L) + 1L;
                blacklist.put(remoteHost, ips);
            }
            log.info("ä½ åˆ·è¿™ä¹ˆå¿«å¹²å˜›é»‘å­ï¼š{}", keyAttr);
            return fallbackMethodResult(jp, blacklistInterceptor.fallbackMethod());
        }

        // è¿”å›ç»“æœæ”¾è¡Œ
        return jp.proceed();
    }

    /**
     * @Description åˆ©ç”¨åå°„å°†fallbackMethodæ–¹æ³•ä½œä¸ºé™æµåçš„è¿”å›å€¼è¿”å›
     * @author polaris
     * @create 2024/6/10
     * @return {@link Object}
     */
    private Object fallbackMethodResult(JoinPoint jp, String fallbackMethod) throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {
        Signature sig = jp.getSignature();
        MethodSignature methodSignature = (MethodSignature) sig;
        Method method = jp.getTarget().getClass().getMethod(fallbackMethod, methodSignature.getParameterTypes());
        return method.invoke(jp.getThis(), jp.getArgs());
    }
}
```

**å®æµ‹**

æ­£å¸¸è®¿é—®

![](https://github.com/polarisronx/Papi-backend/blob/master/doc/images/QQ20240610181110.png)

jmeteræ¯ç§’20æ¬¡è¯·æ±‚

![](https://github.com/polarisronx/Papi-backend/blob/master/doc/images/QQ20240610181252.png)

éƒ¨åˆ†æˆåŠŸ

![](https://github.com/polarisronx/Papi-backend/blob/master/doc/images/QQ20240610183617.png)

éƒ¨åˆ†å¤±è´¥

![](https://github.com/polarisronx/Papi-backend/blob/master/doc/images/QQ20240610183531.png)

![](https://github.com/polarisronx/Papi-backend/blob/master/doc/images/QQ20240610183656.png)





### æ‹“å±•3ï¼šç”¨MongoDBå­˜å‚¨æ–‡æ¡£æ•°æ®

å…ˆäº†è§£ä¸€ä¸‹mongoDBæŠŠ

[ç»éæ›¿ä»£ï¼Œå…¨æ–¹ä½è§£è¯»MySQL ä¸MongoDBçš„åŒºåˆ«_mongodbå’Œmysqlçš„åŒºåˆ«-CSDNåšå®¢](https://blog.csdn.net/javamyfriend/article/details/132246620)

springbootä¸­å¦‚ä½•ä½¿ç”¨MongoDB

[SpringBootä¸­MongoDBçš„ä½¿ç”¨_springboot mongodb-CSDNåšå®¢](https://blog.csdn.net/qq_30614345/article/details/131994743)

> åˆ†åº“å­˜å‚¨ï¼š

ç°åœ¨çš„ä¸€æ¡æ•°æ®åŒ…å«ç”¨æˆ·ä¸Šä¼ çš„åŸå§‹æ•°æ®ï¼Œè¿˜æœ‰AIç”Ÿæˆçš„ç»“è®ºå’Œå›¾è¡¨æ•°æ®ï¼Œååˆ†è‡ƒè‚¿ã€‚è€ƒè™‘å¯¹è¡¨çš„æ•°æ®è¿›è¡Œå‚ç›´åˆ†åº“ã€‚

MongoDBæ˜¯ä¸€ä¸ªé¢å‘æ–‡æ¡£çš„NoSQLæ•°æ®åº“ï¼Œå®ƒä»¥JSONæ ·å¼çš„æ–‡æ¡£å­˜å‚¨æ•°æ®ã€‚è¿™ç§çµæ´»çš„æ•°æ®æ¨¡å‹ä½¿å¾—å¯ä»¥è½»æ¾åœ°å­˜å‚¨å’Œæ£€ç´¢ä¸åŒç»“æ„çš„æ•°æ®ã€‚

MongoDBé‡‡ç”¨Bæ ‘å­˜å‚¨ï¼Œæ”¯æŒç´¢å¼•ï¼Œå•æ¡æ•°æ®æŸ¥è¯¢æ—¶é€Ÿåº¦æ¯”B+æ ‘å¿«ã€‚

> documentè®¾è®¡

1. å¯¹äºç”Ÿæˆçš„å›¾è¡¨ï¼Œä¸»è¦çš„æ“ä½œæ›´å¤šæ˜¯æŸ¥è¯¢ï¼Œä¹Ÿå°±æ˜¯è¯»>>å†™ï¼Œè¿™é‡Œä½¿ç”¨MongoDBè¿›è¡Œä¿¡æ¯å­˜å‚¨ï¼Œæ ‡è®°ä¸ºç±»ChartDocã€‚è€Œå›¾è¡¨çš„åŸå§‹æ•°æ®è¿˜æ˜¯å­˜æ”¾åœ¨MySQLï¼Œä¿ç•™Chartç±»ã€‚

2. å¯¹äºåˆ æ”¹æ“ä½œï¼šæ“ä½œä¸­æœ‰è¾ƒå¤šç”Ÿæˆå¤±è´¥ã€å›¾è¡¨é‡æ–°ç”Ÿæˆæ›´æ–°çš„æƒ…å†µï¼Œç”¨æˆ·åœ¨åˆ æ”¹æ—¶ï¼Œå¾€å¾€æ˜¯è¦åˆ é™¤æˆ–ä¿®æ”¹ç”Ÿæˆçš„å›¾è¡¨ä¿¡æ¯ï¼Œè€Œè¾ƒå°‘å»åˆ é™¤å’Œä¿®æ”¹åŸå§‹æ•°æ®ã€‚ä¸ºé¿å…é‡å¤å ç”¨ä¸»é”®ï¼Œä¹Ÿä¾¿äºMySQLçš„æ•°æ®å’ŒMongoDBçš„æ•°æ®çš„å¯¹åº”å…³ç³»ï¼Œåœ¨ChartDocç±»ä¸­å¢åŠ versionå­—æ®µã€‚ç”¨æˆ·å¯ä»¥æ›´æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ï¼Œä¹Ÿå¯ä»¥åˆ é™¤ä¸€ä¸ªæ—§çš„ç‰ˆæœ¬ï¼Œä½†ä¸€èˆ¬ä¸ç›´æ¥åˆ é™¤æ•´ä¸ªåˆ†æä»»åŠ¡ã€‚
3. å¯¹äºæŸ¥è¯¢æ“ä½œï¼šåœ¨æŸ¥æ‰¾å›¾è¡¨ä¿¡æ¯æ—¶ä¹Ÿæ˜¯å¾€å¾€å»æŸ¥çœ‹ç”Ÿæˆçš„å›¾è¡¨è€Œä¸æ˜¯å»æŸ¥çœ‹åŸå§‹æ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æŸ¥è¯¢MongoDBè¿”å›ç›®æ ‡ã€ç»“è®ºã€å›¾è¡¨ç­‰ä¿¡æ¯ï¼Œè€Œä¸ç”¨å†æŸ¥MySQLã€‚

### æ‹“å±•4ï¼šç­–ç•¥æ¨¡å¼ï¼šåå‘å‹åŠ›

åå‘å‹åŠ›å®é™…ä¸Šæ˜¯ **æµé‡æ§åˆ¶** çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥ä½¿å¾—è°ƒç”¨æ–¹å’Œå¤„ç†æ–¹çš„èƒ½åŠ›ç›¸åŒ¹é…ï¼Œä»è€Œä¿æŠ¤ç³»ç»Ÿçš„å„èŠ‚ç‚¹å¤„äºæŒç»­çš„æ­£å¸¸å·¥ä½œçŠ¶æ€ã€‚ç®€è¨€ä¹‹ï¼Œç”±æœåŠ¡ç«¯çš„çŠ¶æ€åå‘è°ƒèŠ‚å®¢æˆ·ç«¯è¯·æ±‚çš„æ‰§è¡Œã€‚

> è¦ç‚¹1ï¼šæœåŠ¡å®ä¾‹çš„ç¹å¿™ç¨‹åº¦æŒ‡æ ‡

è¡¡é‡æŒ‡æ ‡ï¼š

1. cpuä½¿ç”¨ç‡
2. å†…å­˜ä½¿ç”¨ç‡
3. ç£ç›˜IOä½¿ç”¨ç‡
4. ç½‘ç»œå¸¦å®½ä½¿ç”¨ç‡

å°†æœåŠ¡å™¨çš„çŠ¶æ€åˆ’åˆ†ä¸º

1. éå¸¸é«˜åº¦è´Ÿè½½ VeryHighLoadï¼šCPU > 90%, å†…å­˜ > 80% or ç£ç›˜IO>80% or ç½‘ç»œIO>90%
2. é«˜åº¦è´Ÿè½½ HighLoadï¼šCPU > 60% or å†…å­˜ > 40% or ç£ç›˜IO>40% or ç½‘ç»œIO>60%
3. ä¸­åº¦è´Ÿè½½ MediumLoadï¼šCPU > 30%, å†…å­˜ > 30% or ç£ç›˜IO>30% or ç½‘ç»œIO>30%
4. è½»åº¦è´Ÿè½½ LightLoadï¼šother

> å‹åŠ›ç­–ç•¥

é’ˆå¯¹æœåŠ¡å™¨çš„ä¸åŒè´Ÿè½½æƒ…å†µï¼Œé‡‡ç”¨çš„å‹åŠ›ç­–ç•¥ï¼š

1. éå¸¸é«˜åº¦è´Ÿè½½ VeryHighLoadï¼šæ‹’ç»è¯·æ±‚ Reject
2. é«˜åº¦è´Ÿè½½ HighLoadï¼šåŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ’é˜Ÿæ‰§è¡Œ MQ
3. ä¸­åº¦è´Ÿè½½ MediumLoadï¼šåŠ å…¥ç³»ç»Ÿå¼€è¾Ÿçš„çº¿ç¨‹æ± ä¸­æ’é˜Ÿæ‰§è¡Œ Pool
4. è½»åº¦è´Ÿè½½ LightLoadï¼šé‡‡ç”¨åŒæ­¥ç”Ÿæˆ Syncï¼Œè¯·æ±‚äº¤ä»˜æœåŠ¡å™¨æ‰§è¡Œ

serviceä¸­æ³¨å…¥äº†ç­–ç•¥é€‰æ‹©å™¨StrategySelectorå®ä¾‹ï¼Œåœ¨selectorä¸­ï¼Œmapå­˜æ”¾äº†ä¸åŒç­–ç•¥çš„å®ä¾‹

```java
public GenChartStrategy selectStrategy(ServerLoadInfo info) {
    if (info.isVeryHighLoad()) {
        return strategyMap.get(GenChartStrategyEnum.GEN_REJECT.getValue());
    } else if (info.isHighLoad()) {
        return strategyMap.get(GenChartStrategyEnum.GEN_MQ.getValue());
    } else if (info.isMediumLoad()) {
        return strategyMap.get(GenChartStrategyEnum.GEN_THREAD_POOL.getValue());
    } else {
        return strategyMap.get(GenChartStrategyEnum.GEN_SYNC.getValue());
    }
}
```



### **åç«¯å¯åŠ¨é¡¹ç›®ç«¯å£å†²çªé—®é¢˜è§£å†³**

åŸå› :Windows Hyper-V è™šæ‹ŸåŒ–å¹³å°å ç”¨äº†ç«¯å£
å…ˆä½¿ç”¨: netsh interface ipv4 show excludedportrange protocol=tcpæŸ¥çœ‹è¢«å ç”¨çš„ç«¯å£ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªæ²¡è¢«å ç”¨çš„ç«¯å£å¯åŠ¨é¡¹ç›®



### **EasyExcelè¯»å–æ•°æ®**

å¾—åˆ°çš„æ˜¯Mapç±»å‹çš„é›†åˆ

```java
//è¯»å–æ•°æ®
List<Map<Integerï¼ŒString>> list = EasyExcel.read(file)
.excelType(ExcelTypeEnum.XLSX)
.sheet()
.headRowNumber(0)
.doReadSync();
```

åº”è¯¥è½¬ä¸ºLinkedHashMapï¼ŒHashMapæ˜¯ä¹±åºçš„ï¼Œç”¨è¿™ä¸ªæ›´å¥½





### **è°ƒç”¨AI**

AIé¢„è®¾ï¼Œæå‰å‘Šè¯‰AIè§’è‰²ï¼ŒåŠŸèƒ½ï¼Œå›å¤è¦æ±‚ã€‚openaiæ˜¯æ— çŠ¶æ€çš„æ¥å£ï¼Œæ¯æ¬¡éƒ½éœ€è¦æŠŠç³»ç»Ÿçš„é¢„è®¾å‘Šè¯‰AIã€‚

åœ¨ç³»ç»Ÿæ¨¡å‹å±‚é¢åšé¢„è®¾ä¼šæ¯”ç›´æ¥æŠŠé¢„è®¾æ‹¼æ¥åœ¨æ¶ˆæ¯é‡Œæ•ˆæœæ›´å¥½

AIæœ‰ä¸Šä¸‹æ–‡å…³è”é™åˆ¶

#### **åˆ©ç”¨AIç”Ÿæˆç»“è®ºå’Œå›¾è¡¨**

AIä¸èƒ½ç›´æ¥ç”Ÿæˆå›¾è¡¨ï¼ŒAIç”Ÿæˆå‰ç«¯ä»£ç ä½¿ç”¨å‰ç«¯ç»„ä»¶åº“ï¼ˆechartsï¼‰æ¥æ˜¾ç¤ºå›¾è¡¨

#### **AIæè¯æŠ€å·§**

tokenæœ‰é™ï¼Œè¾“å…¥å¤ªå¤šAIå¯èƒ½åªæ¥å—å°‘éƒ¨åˆ†

1. **æŒç»­è¾“å…¥ï¼ŒæŒç»­ä¼˜åŒ–**
2. **å®ä¾‹é—®ç­”ï¼Œç»™å‡ºé¢„æœŸçš„å›ç­”æ ¼å¼**
3. **æ•°æ®å‹ç¼©ï¼Œæå–å…³é”®è¯**ï¼ˆä¹Ÿå¯ä»¥è®©AIæ¥æå–å…³é”®è¯ï¼Œè®©ä»–ç”¨æœ€å°‘çš„å­—æ¥è¡¨è¾¾æ•°æ®ï¼‰

ç¬¬ä¸€è¡Œ:æ—¥æœŸ: 1å·ï¼Œç”¨æˆ·æ•°: 10äºº       è¡¨å¤´:æ—¥æœŸï¼Œç”¨æˆ·æ•°

ç¬¬äºŒè¡Œ:æ—¥æœŸ: 2å·ï¼Œç”¨æˆ·æ•°: 20äºº  -->1å·,10

ç¬¬ä¸‰è¡Œ:æ—¥æœŸ: 3å·ï¼Œç”¨æˆ·æ•°: 30äºº       2å·,20

â€‹                                                             3å·,30

4. **æ§åˆ¶è¾“å…¥æ ¼å¼**

å¦‚ä½ ç»™AIä¸€ä¸ªé¢„è®¾ï¼Œä¼šç»™ä»–æä¾›åˆ†æéœ€æ±‚å’Œæ•°æ®ï¼Œé‚£ä¹ˆæé—®æ—¶å°±æŒ‰ç…§è¿™ä¸ªå½¢å¼æä¾›ç»™AI

5. **æ§åˆ¶è¾“å‡ºæ ¼å¼**

ç”¨ç‰¹æ®Šçš„ç¬¦å·æ¥åˆ†éš”ä»£ç å’Œç»“è®º

```bash
ä½ æ˜¯ä¸€ä¸ªæ•°æ®åˆ†æå¸ˆå’Œå‰ç«¯å¼€å‘ä¸“å®¶ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šæŒ‰ç…§ä»¥ä¸‹å›ºå®šæ ¼å¼ç»™ä½ æä¾›å†…å®¹:
åˆ†æéœ€æ±‚:
{æ•°æ®åˆ†æçš„éœ€æ±‚æˆ–è€…ç›®æ ‡}
åŸå§‹æ•°æ®:
{csvæ ¼å¼çš„åŸå§‹æ•°æ®ï¼Œç”¨ï¼Œä½œä¸ºåˆ†éš”ç¬¦}
è¯·æ ¹æ®è¿™ä¸¤éƒ¨åˆ†å†…å®¹ï¼ŒæŒ‰ç…§ä»¥ä¸‹æŒ‡å®šæ ¼å¼ç”Ÿæˆå†…å®¹ï¼ˆæ­¤å¤–ä¸è¦è¾“å‡ºä»»ä½•å¤šä½™çš„å¼€å¤´ã€ç»“å°¾ã€æ³¨é‡Š)
ã€ã€ã€ã€ã€
{å‰ç«¯Echarts V5çš„optioné…ç½®å¯¹è±¡jsä»£ç ï¼Œåˆç†åœ°å°†æ•°æ®è¿›è¡Œå¯è§†åŒ–ï¼Œä¸è¦ç”Ÿæˆä»»ä½•å¤šä½™çš„å†…å®¹ï¼Œæ¯”å¦‚æ³¨é‡Š}
ã€ã€ã€ã€ã€
{æ˜ç¡®çš„æ•°æ®åˆ†æç»“è®ºã€è¶Šè¯¦ç»†è¶Šå¥½ï¼Œä¸è¦ç”Ÿæˆå¤šä½™çš„æ³¨é‡Š}

ç”Ÿæˆçš„å†…å®¹ï¼š
ã€ã€ã€ã€ã€
...å‰ç«¯ä»£ç ...
ã€ã€ã€ã€ã€
...ç»“è®º...
```

#### è°ƒç”¨AIæ¥å£

1.ç›´æ¥è°ƒç”¨OpenAIæˆ–è€…å…¶ä»–AIå¤§æ¨¡å‹å®˜ç½‘çš„æ¥å£

ä¼˜ç‚¹ï¼šä¸ç»å°è£…ï¼Œæœ€çµæ´»ï¼Œæœ€åŸå§‹

è¦é’±ï¼Œè¦æ¢¯å­

ä½¿ç”¨ï¼š

- è¯·æ±‚å¤´ä¸­åŠ authorizationåŠ Key
- æ‰¾åˆ°å¯¹åº”çš„æ¥å£ï¼Œä¸€èˆ¬æ˜¯chatæ¥å£
- å‘èµ·Httpè¯·æ±‚









### å‰ç«¯

è¡¨å•ï¼Œnameå¯¹åº”äº†åç«¯çš„å­—æ®µå±æ€§ï¼Œplaceholderæ˜¯è¡¨å•æ çš„æç¤ºå†…å®¹

![](https://github.com/polarisronx/Papi-backend/blob/master/doc/images/QQ20240428144855.png)

```tsx
useEffect( () => {
...é€»è¾‘...
},[ ...å˜é‡æ•°ç»„...])
```

é¡µé¢åˆæ¬¡åŠ è½½å’Œå˜é‡æ•°ç»„ä¸­çš„å˜é‡çš„å€¼å‘ç”Ÿæ”¹å˜æ—¶ä¼šæ‰§è¡Œ{}å†…çš„é€»è¾‘ã€‚

è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯

```tsx
const { initialState } = useModel('@@initialstate');
const { currentUser } = initialState ?? {};
```

### ä¼˜åŒ–

- **å®‰å…¨æ€§**ï¼šæ ¡éªŒæ–‡ä»¶ç±»å‹ã€æ ¡éªŒå¤§å°ã€æ•æ„Ÿä¿¡æ¯æ ¡éªŒ

  å¯ä»¥æ¥å…¥è…¾è®¯äº‘çš„å›¾ç‰‡ä¸‡è±¡æ•°æ®å®¡æ ¸ï¼ˆCOSå¯¹è±¡å­˜å‚¨çš„å®¡æ ¸åŠŸèƒ½

- **æ•°æ®å­˜å‚¨**ï¼š

  **åˆ†ç‰‡ä¸Šä¼ **

  åˆ†åº“åˆ†è¡¨ï¼šç”¨æˆ·çš„åŸå§‹æ•°æ®å­˜åœ¨è¡¨å†…çš„ä¸€ä¸ªå­—æ®µéš¾ä»¥ç»´æŠ¤ï¼Œä¼šè®©æŸ¥è¯¢å˜æ…¢ï¼Œå¹¶ä¸”ç”¨æˆ·å¦‚æœè¦æŸ¥çœ‹åŸå§‹æ•°æ®ï¼Œè·å–æŒ‡å®šçš„å­—æ®µï¼Œå¯ä»¥ä¸ºæ¯ä¸ªå›¾è¡¨å•ç‹¬å¼€è¾Ÿä¸€ä¸ªè¡¨æ¥è®°å½•æ•°æ® chart_{å›¾è¡¨ID}

  åŠ¨æ€SQL

  **åˆ†åº“åˆ†è¡¨**ï¼š

  **1.æ°´å¹³åˆ†è¡¨**ï¼šæ°´å¹³åˆ†è¡¨æ˜¯å°†åŒä¸€å¼ è¡¨ä¸­çš„æ•°æ®æŒ‰ä¸€å®šçš„è§„åˆ™åˆ’åˆ†åˆ°ä¸åŒçš„ç‰©ç†å­˜å‚¨ä½ç½®ä¸Šï¼Œä»¥è¾¾åˆ°åˆ†æ‘Šå•å¼ è¡¨çš„æ•°æ®åŠè®¿é—®å‹åŠ›çš„ç›®çš„ã€‚æ•°æ®è¶Šå¤š B+ æ ‘å°±è¶Šé«˜ï¼Œè®¿é—®çš„æ€§èƒ½å°±å·®ï¼Œæ‰€ä»¥è¿›è¡Œæ°´å¹³æ‹†åˆ†ã€‚æœ‰åŸºäºhash-basedåˆ†è¡¨å’Œrange-basedåˆ†è¡¨ã€‚

  æ°´å¹³åˆ†è¡¨çš„**ä¼˜ç‚¹**

  ï¼ˆ1ï¼‰å•ä¸ªè¡¨çš„æ•°æ®é‡å‡å°‘ï¼Œæé«˜äº†è¯»å†™æ€§èƒ½ï¼Œå‡å°‘äº†å•è¡¨çš„å‹åŠ›ï¼›

  ï¼ˆ2ï¼‰å¯ä»¥é€šè¿‡å¢åŠ èŠ‚ç‚¹ï¼Œæé«˜ç³»ç»Ÿçš„æ‰©å±•æ€§å’Œå®¹é”™æ€§ã€‚

  æ°´å¹³åˆ†è¡¨çš„**ç¼ºç‚¹**

  ï¼ˆ1ï¼‰äº‹åŠ¡å¹¶å‘å¤„ç†å¤æ‚åº¦å¢åŠ ï¼Œéœ€è¦å¢åŠ åˆ†å¸ƒå¼äº‹åŠ¡çš„ç®¡ç†ï¼Œæ€§èƒ½å’Œå¤æ‚åº¦éƒ½æœ‰æ‰€ç‰ºç‰²ï¼›

  ï¼ˆ2ï¼‰è·¨èŠ‚ç‚¹æŸ¥è¯¢å›°éš¾ï¼Œéœ€è¦è®¾è®¡è·¨èŠ‚ç‚¹çš„æŸ¥è¯¢æ¨¡å—ã€‚

  **2.å‚ç›´åˆ†è¡¨**ï¼šå‚ç›´åˆ†è¡¨ä¸€èˆ¬æ˜¯å°†**<font color='red'>ä¸å¸¸ç”¨çš„å­—æ®µ</font>**å•ç‹¬æ”¾åœ¨ä¸€å¼ è¡¨ã€å°†**<font color='red'>å¤§å­—æ®µ</font>**åˆ†ä¸€å¼ è¡¨ã€æŠŠç»å¸¸éœ€è¦åŒæ—¶æŸ¥å‡ºæ¥çš„ä¿¡æ¯æ”¾ä¸€å¼ è¡¨ã€‚è¿™æ ·åšå¯ä»¥å†·æ•°æ®å’Œçƒ­æ•°æ®åˆ†å¼€æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚

  **3.å‚ç›´åˆ†åº“**ï¼šæŒ‡çš„æ˜¯æ ¹æ®ä¸šåŠ¡æ¨¡å—çš„ä¸åŒï¼Œå°†ä¸åŒçš„å­—æ®µæˆ–è¡¨åˆ†åˆ°ä¸åŒçš„æ•°æ®åº“ä¸­ã€‚å‚ç›´åˆ†åº“åŸºäºæ•°æ®åº“å†…æ ¸æ”¯æŒï¼Œå¯¹åº”ç”¨é€æ˜ï¼Œæ— éœ€é¢å¤–çš„å¼€å‘ä»£ç ï¼Œæ˜“äºç»´æŠ¤å‡çº§ã€‚

  å‚ç›´åˆ†åº“çš„**ä¼˜ç‚¹**

  ï¼ˆ1ï¼‰å‡å°‘å•ä¸ªæ•°æ®åº“çš„æ•°æ®é‡ï¼Œæé«˜ç³»ç»Ÿçš„æŸ¥è¯¢æ•ˆç‡ã€‚Â·å¢åŠ äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ï¼Œæ¯”æ°´å¹³åˆ†è¡¨æ›´å®¹æ˜“å®ç°ã€‚

  å‚ç›´åˆ†åº“çš„**ç¼ºç‚¹**

  ï¼ˆ1ï¼‰ä¸åŒæ•°æ®åº“ä¹‹é—´çš„ç»´æŠ¤å’ŒåŒæ­¥æˆæœ¬è¾ƒé«˜ã€‚

  ï¼ˆ2ï¼‰ç°æœ‰ç³»ç»Ÿçš„æ”¹é€ å­˜åœ¨ä¸€å®šçš„éš¾åº¦ã€‚
  
  ï¼ˆ3ï¼‰ç³»ç»Ÿçš„æ€§èƒ½ä¼šå—åˆ°æ•°æ®åº“ä¹‹é—´äº’ç›¸å½±å“çš„å½±å“ã€‚
  
  4.æ°´å¹³åˆ†åº“
  
  ï¼ˆ1ï¼‰æé«˜è¯»å†™æ€§èƒ½ï¼Œå› ä¸ºå‡å°‘äº†å•ä¸€æ•°æ®åº“çš„è¯»å†™å‹åŠ›ã€‚
  
  ï¼ˆ2ï¼‰èƒ½æé«˜å­˜å‚¨å®¹é‡ã€‚å¯ä»¥é€šè¿‡å¢åŠ æˆ–å‡å°‘æ•°æ®åº“è¿›è¡Œå¼¹æ€§ä¼¸ç¼©ã€‚
  
  ï¼ˆ3ï¼‰æé«˜å®¹é”™æ€§ã€‚å½“ä¸€ä¸ªæ•°æ®åº“æ•…éšœäº†ï¼Œåˆ«çš„æ•°æ®åº“è¿˜èƒ½æ­£å¸¸è¿è¡Œï¼Œåªå½±å“å°éƒ¨åˆ†æ•°æ®æŸ¥è¯¢ã€‚

3. **é™æµ**ï¼šè®¡ç®—èµ„æºæ˜¯æœ‰é™çš„ï¼Œç”šè‡³éœ€è¦æ¶ˆè€—æˆæœ¬

â‘ æ§åˆ¶æ¬¡æ•°ï¼Œâ‘¡æ§åˆ¶å•ä½æ—¶é—´å†…çš„å¹¶å‘é‡

é™æµé˜ˆå€¼å¤šå¤§åˆé€‚ï¼Ÿè¦è°ƒç ”å‚è€ƒæ­£å¸¸ç”¨æˆ·ä¸€èˆ¬çš„ä½¿ç”¨é¢‘ç‡ 



**é™æµçš„æ€æƒ³**

(1)**å›ºå®šçª—å£é™æµ**

å•ä½æ—¶é—´å†…é™åˆ¶æ¬¡æ•°ï¼šå¦‚1å°æ—¶é™åˆ¶10ä¸ªç”¨æˆ·ä½¿ç”¨

ä¼˜ç‚¹ï¼šæœ€ç®€å•

ç¼ºç‚¹ï¼šå¯èƒ½å‡ºç°æµé‡çªåˆºï¼Œå¦‚å‰59åˆ†é’Ÿæ²¡æœ‰æ“ä½œï¼Œæœ€å1åˆ†é’Ÿæœ‰10ä¸ªæ“ä½œï¼Œç¬¬61åˆ†é’Ÿåˆæ¥äº†10ä¸ªæ“ä½œï¼Œ20ä¸ªæ“ä½œé›†ä¸­åœ¨ä¸¤åˆ†é’Ÿå†…

ä¸¾ä¾‹ï¼šKFCæ¯ä¸ªæ•´ç‚¹æä¾›30ä¸ªæ±‰å ¡

(2)**æ»‘åŠ¨çª—å£é™æµ**

æ»‘åŠ¨çª—å£ç®—æ³•çš„å…³é”®æ˜¯å°†å¤§çš„æ—¶é—´çª—å£åˆ‡åˆ†ä¸ºå¤šä¸ªè¾ƒå°çš„çª—å£ç‰‡æ®µï¼Œæ¯ä¸ªå­çª—å£éƒ½æœ‰è‡ªå·±çš„è®¡æ•°é™åˆ¶ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæœ€æ—§çš„å­çª—å£ä¼šè¢«æ–°çš„å­çª—å£æ›¿ä»£ï¼Œå½¢æˆä¸€ç§â€œæ»‘åŠ¨â€çš„æ•ˆæœã€‚

ä¼˜ç‚¹ï¼šèƒ½é¿å…æµé‡çªåˆº

ç¼ºç‚¹ï¼šç›¸å¯¹å¤æ‚ï¼Œé™æµæ•ˆæœå—æ»‘åŠ¨å•ä½å½±å“

ä¸¾ä¾‹ï¼šKFCæ¯10åˆ†é’Ÿæä¾›5ä¸ªæ±‰å ¡

(3)**æ¼æ¡¶é™æµ**ï¼ˆæ¨èï¼‰

ä»¥å›ºå®šçš„é€Ÿç‡å¤„ç†è¯·æ±‚ï¼ˆå¦‚æ¯0.1ç§’å¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼‰ï¼Œå½“è¯·æ±‚æ¡¶æ»¡äº†ä»¥åï¼Œæ‹’ç»è¯·æ±‚ã€‚

æ¡¶è£…å¾…å¤„ç†çš„è¯·æ±‚ï¼Œæ¡¶æ»¡äº†å°±ä¸å†æ¥æ”¶ï¼Œæ¼æ°´æŒ‡çš„æ˜¯å¤„ç†è¯·æ±‚ï¼Œå¹¶ä¸”æ˜¯å›ºå®šé€Ÿç‡

ä¼˜ç‚¹ï¼šèƒ½ä¸€å®šç¨‹åº¦ä¸Šé¿å…æµé‡çªåˆºï¼ŒåŒæ—¶å›ºå®šé€Ÿç‡å¤„ç†ä¿è¯äº†æœåŠ¡å™¨çš„å®‰å…¨

ç¼ºç‚¹ï¼šå›ºå®šé€Ÿç‡çš„ç¼ºç‚¹ï¼Œæ²¡æœ‰åŠæ³•æŒ‰éœ€è°ƒæ§ï¼Œåªèƒ½æŒ‰é¡ºåºä¸€ä¸ªä¸€ä¸ªæ¥ã€‚

ä¸¾ä¾‹ï¼šKFCèƒ½é—¨åº—å†…å®¹çº³10ä¸ªäººï¼Œæ¯2åˆ†é’Ÿæä¾›ç»™é—¨åº—å†…çš„é£Ÿå®¢1ä¸ªæ±‰å ¡

(4)**ä»¤ç‰Œæ¡¶é™æµ**ï¼ˆæ¨èï¼‰

ç³»ç»Ÿç”Ÿæˆä¸€æ‰¹ä»¤ç‰Œï¼Œç”¨æˆ·æ“ä½œå‰å»å–ä»¤ç‰Œï¼Œæ‹¥æœ‰ä»¤ç‰Œçš„ç”¨æˆ·å°±æœ‰èµ„æ ¼è¿›è¡Œæ“ä½œï¼ˆæˆ–ä¸å…¶ä»–ç”¨æˆ·åŒæ—¶æ“ä½œï¼‰ï¼Œæ‹¿ä¸åˆ°ä»¤ç‰Œçš„åªèƒ½ç­‰ã€‚

ä¼˜ç‚¹ï¼šèƒ½å¹¶å‘å¤„ç†è¯·æ±‚ï¼Œæ€§èƒ½æ›´é«˜

ç¼ºç‚¹ï¼šæ—¶é—´å•ä½çš„ä»¤ç‰Œæ´¾å‘æ˜¯éœ€è¦æ–Ÿé…Œçš„

ä¸¾ä¾‹ï¼šKFCèƒ½ä¸ºé—¨åº—å†…1~10å·æ¡Œä¾›é¤ï¼Œåœ¨æ²¡ç©ºå‡ºæ–°çš„æ¡Œå­å‰æ— æ³•ä¾›é¤

**å¦‚ä½•å®ç°ï¼Ÿ**

- å¯¹äºåªæœ‰ä¸€å°æœåŠ¡å™¨çš„å•æœºé™æµï¼ˆæœ¬åœ°é™æµï¼‰

  ç”¨ç¬¬ä¸‰æ–¹javaåº“ï¼Œgoogleçš„Grava rateLimiter

- å¯¹äºæœ‰å¤šå°æœåŠ¡å™¨çš„é›†ç¾¤ç¯å¢ƒï¼ˆåˆ†å¸ƒå¼é™æµï¼‰ã€å¾®æœåŠ¡

  â‘ æŠŠç”¨æˆ·çš„ä½¿ç”¨è®°å½•é›†ä¸­åœ¨æŒ‡å®šçš„å­˜å‚¨ä¸­æ¥ç»Ÿè®¡ï¼Œæ¯”å¦‚Redisï¼Œè¿™æ ·æ— è®ºç”¨æˆ·çš„è¯·æ±‚è½åˆ°å“ªå°æœåŠ¡å™¨ï¼Œéƒ½ä»¥é›†ä¸­çš„æ•°æ®å­˜å‚¨å†…çš„æ•°æ®ä¸ºå‡†

  â‘¡åœ¨ç½‘å…³è¿›è¡Œé›†ä¸­çš„é™æµå’Œç»Ÿè®¡ï¼ˆæ¯”å¦‚Alibabaçš„Sentinelå’Œspring cloudçš„Gatewayï¼‰

ä¸¾ä¾‹ï¼šredissionï¼š

```java
RRedisLimiter tateLimiter = redissionClient.getRateLimiter(key);// ä¸åŒçš„keyä»£è¡¨ä¸åŒçš„é™æµå™¨ï¼Œå¯¹ä¸åŒå¯¹è±¡é™æµäº’ä¸å¹²æ‰°
rateLimiter.trySetRate(RateType.OVERALL,2,1,RateIntervalUnit.SECOND);//p1:é™æµæ¨¡å¼ï¼šoverallå¯¹å¤šæœåŠ¡å™¨ç»Ÿä¸€è®¡æ•°
// æ¯å½“ä¸€ä¸ªæ“ä½œæ¥äº†ï¼Œéœ€è¦è¯·æ±‚å¤šå°‘ä¸ªè¯·æ±‚ä»¤ç‰Œ(permits)
boolean canOp = rateLimiter.tryAcquire(3);// p1:permits
if(!canOp) throw new BusinessException(ErrorCode.Too_MANY_REQUEST);
```

è®¾ç½®é™æµçš„ç²’åº¦ï¼šè®¾ç½®keyï¼Œé’ˆå¯¹æ¥å£ã€æ–¹æ³•ã€ç”¨æˆ·

### å¼‚æ­¥åŒ–

> æ ‡å‡†å¼‚æ­¥åŒ–çš„ä¸šåŠ¡æµç¨‹

1. å½“ç”¨æˆ·è¦è¿›è¡Œè€—æ—¶å¾ˆé•¿çš„æ“ä½œæ—¶ï¼Œç‚¹å‡»æäº¤åï¼Œä¸éœ€è¦åœ¨ç•Œé¢å‚»ç­‰ï¼Œè€Œæ˜¯åº”è¯¥æŠŠè¿™ä¸ªä»»åŠ¡ä¿å­˜åˆ°æ•°æ®åº“ä¸­è®°å½•ä¸‹æ¥

2. ç”¨æˆ·è¦æ‰§è¡Œæ–°ä»»åŠ¡æ—¶

â€‹		a.ä»»åŠ¡æäº¤æˆåŠŸ

â€‹			i. å¦‚æœæˆ‘ä»¬çš„ç¨‹åºè¿˜æœ‰å¤šä½™çš„ç©ºé—²çº¿ç¨‹ï¼Œå¯ä»¥ç«‹åˆ»å»åšè¿™ä¸ªä»»åŠ¡

â€‹			ii. å¦‚æœæˆ‘ä»¬çš„ç¨‹åºçš„çº¿ç¨‹éƒ½åœ¨ç¹å¿™ï¼Œæ— æ³•ç»§ç»­å¤„ç†ï¼Œé‚£å°±æ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—é‡Œ

â€‹		b.ä»»åŠ¡æäº¤å¤±è´¥:æ¯”å¦‚æˆ‘ä»¬çš„ç¨‹åºæ‰€æœ‰çº¿ç¨‹éƒ½åœ¨å¿™ï¼Œä»»åŠ¡é˜Ÿåˆ—æ»¡äº†

â€‹			i. æ‹’ç»æ‰è¿™ä¸ªä»»åŠ¡ï¼Œå†ä¹Ÿä¸å»æ‰§è¡Œ

â€‹			ii.é€šè¿‡ä¿å­˜åˆ°æ•°æ®åº“ä¸­çš„è®°å½•æ¥çœ‹åˆ°æäº¤å¤±è´¥çš„ä»»åŠ¡ï¼Œå¹¶ä¸”åœ¨ç¨‹åºé—²çš„æ—¶å€™ï¼Œå¯ä»¥æŠŠä»»åŠ¡ä»æ•°æ®åº“ä¸­æåˆ°ç¨‹åºé‡Œï¼Œå†å»æ‰§è¡Œ

3. ç¨‹åºï¼ˆçº¿ç¨‹ï¼‰ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡ä¾æ¬¡æ‰§è¡Œï¼Œæ²¡å®Œæˆæ„è§äº‹æƒ…å°±è¦ä¿®æ”¹ä¸€ä¸‹ä»»åŠ¡çš„çŠ¶æ€ã€‚
4. ç”¨æˆ·å¯ä»¥æŸ¥è¯¢ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ï¼Œæˆ–è€…åœ¨ä»»åŠ¡æ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥æ—¶èƒ½å¤Ÿæ¥æ”¶åˆ°é€šçŸ¥ï¼ˆé‚®ä»¶ã€ç³»ç»Ÿæ¶ˆæ¯æç¤ºã€çŸ­ä¿¡ï¼‰
5. å¦‚æœè¦æ‰§è¡Œçš„ä»»åŠ¡éå¸¸å¤æ‚ï¼ŒåŒ…å«å¾ˆå¤šç¯èŠ‚ï¼Œåœ¨æ¯å®Œæˆä¸€ä¸ªå°çš„ä»»åŠ¡æ—¶ï¼Œè¦åœ¨ç¨‹åºï¼ˆæ•°æ®åº“ï¼‰ä¸­è¿›è¡Œè®°å½•ï¼Œç”¨æˆ·å¯ä»¥æŸ¥çœ‹åˆ°ä»»åŠ¡æ‰§è¡Œåˆ°çš„çŠ¶æ€ã€‚ï¼ˆè¿›åº¦æ¡)

> çº¿ç¨‹æ± 

- ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± 

çº¿ç¨‹çš„ç®¡ç†æ¯”è¾ƒå¤æ‚ï¼ˆä»€ä¹ˆæ—¶å€™æ–°å¢çº¿ç¨‹ã€ä»€ä¹ˆæ—¶å€™å‡å°‘ç©ºé—²çº¿ç¨‹ï¼‰

ä»»åŠ¡çš„å­˜å–æ¯”è¾ƒå¤æ‚ï¼ˆä»€ä¹ˆæ—¶å€™æ¥å—ä»»åŠ¡ï¼Œä»€ä¹ˆæ—¶å€™æ‹’ç»ï¼Œä¸è®©ä»»åŠ¡è¢«é‡å¤æ‰§è¡Œï¼‰

- çº¿ç¨‹æ± çš„ä½œç”¨

å¸®åŠ©ä½ è½»æ¾ç®¡ç†çº¿ç¨‹ã€åè°ƒä»»åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹ã€‚

æ‰©å……ï¼šå¯ä»¥å‘çº¿ç¨‹æ± è¡¨è¾¾ä½ çš„éœ€æ±‚ï¼Œæ¯”å¦‚æœ€å¤šåªå…è®¸å››ä¸ªäººåŒæ—¶æ‰§è¡Œä»»åŠ¡ã€‚çº¿ç¨‹æ± å°±èƒ½è‡ªåŠ¨ä¸ºä½ è¿›è¡Œç®¡ç†ã€‚åœ¨ä»»åŠ¡ç´§æ€¥æ—¶ï¼Œå®ƒä¼šå¸®ä½ å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ã€‚è€Œåœ¨ä»»åŠ¡ä¸ç´§æ€¥æˆ–è€…è¿˜æœ‰çº¿ç¨‹ç©ºé—²æ—¶ï¼Œå®ƒä¼šç›´æ¥å°†ä»»åŠ¡äº¤ç»™ç©ºé—²çš„çº¿ç¨‹ï¼Œè€Œä¸æ˜¯æ”¾å…¥é˜Ÿåˆ—ã€‚

- çº¿ç¨‹æ± çš„å®ç°

Springçš„ThreadPoolTaskExecutoré…åˆ@Asyncæ³¨è§£å®ç°ã€‚Java JUCå¹¶å‘ç¼–ç¨‹åŒ… ThreadPoolExecutorã€‚

æ€ä¹ˆç¡®å®šçº¿ç¨‹æ± å‚æ•°ï¼Ÿè€ƒè™‘ç³»ç»Ÿæœ€è„†å¼±çš„ç¯èŠ‚ 

corePoolSize æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šä¸€èˆ¬æƒ…å†µä¸‹ç³»ç»Ÿèƒ½åŒæ—¶å·¥ä½œçš„çº¿ç¨‹æ•°ï¼ˆæ­£å¼å‘˜å·¥ï¼Œéšæ—¶å°±ç»ªï¼‰

maximumPoolSize æœ€å¤§çº¿ç¨‹æ•°ï¼šæé™æƒ…å†µä¸‹æœ€å¤šçš„çº¿ç¨‹æ•°ï¼ˆåŠ ä¸Šä¸´æ—¶å‘˜å·¥ï¼‰

keepAliveTime ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ï¼šéæ ¸å¿ƒçº¿ç¨‹åœ¨æ²¡æœ‰ä»»åŠ¡çš„æƒ…å†µä¸‹å¤šé•¿æ—¶é—´åˆ é™¤ï¼ˆå¼€é™¤ä¸´æ—¶å‘˜å·¥ï¼‰ï¼Œä»è€Œé‡Šæ”¾æ— ç”¨çš„çº¿ç¨‹èµ„æºã€‚

unit æ—¶é—´å•ä½ï¼š

workQueue å·¥ä½œé˜Ÿåˆ—ï¼šç”¨äºå­˜æ”¾çº¿ç¨‹è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆè¦è®¾ç½®é˜Ÿåˆ—é•¿åº¦ï¼‰

threadFactory çº¿ç¨‹å·¥å‚ï¼šæ§åˆ¶æ¯ä¸ªçº¿ç¨‹çš„ç”Ÿæˆã€ç°æˆçš„å±æ€§ï¼ˆæ¯”å¦‚çº¿ç¨‹åï¼‰

RejectExecutionHandle æ‹’ç»ç­–ç•¥ï¼šä»»åŠ¡é˜Ÿåˆ—æ»¡çš„æ—¶å€™é‡‡å–çš„æªæ–½

**<font color='red'>èµ„æºéš”ç¦»ç­–ç•¥</font>**ï¼šå¯¹äºé‡è¦çš„ä»»åŠ¡ï¼ˆå¦‚VIPç”¨æˆ·çš„æ“ä½œï¼‰ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¯¹äºæ™®é€šçš„ä»»åŠ¡ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆæ™®é€šç”¨æˆ·ï¼‰

å¯¹äºVIPç”¨æˆ·çš„é™æµç­–ç•¥ä¹Ÿå¯ä»¥ç‰¹åˆ«è®¾ç½®

**çº¿ç¨‹æ± å·¥ä½œè¿‡ç¨‹**ï¼š

å½“ä»»åŠ¡æ•°<corePoolSizeï¼Œä»»åŠ¡ä¼šè¢«å·¥ä½œçº¿ç¨‹ç›´æ¥æ‰§è¡Œï¼ˆè€Œä¸ä¼šæ”¾å…¥é˜Ÿåˆ—ï¼‰ï¼ˆæƒ°æ€§åŠ è½½æ ¸å¿ƒçº¿ç¨‹ï¼‰

å½“å·¥ä½œçº¿ç¨‹éƒ½åœ¨å·¥ä½œï¼Œè¿˜æœ‰é¢å¤–çš„ä»»åŠ¡ï¼Œå°±ä¼šæŠŠä»»åŠ¡æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼ˆä¸ä¼šé©¬ä¸Šå¢åŠ ä¸´æ—¶çº¿ç¨‹ï¼‰

å½“ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†ï¼Œä¼šæ–°å¢çº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ï¼ˆæ–°çš„ä»»åŠ¡ä¼šè¢«ç›´æ¥æ‰§è¡Œï¼‰

å½“ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†ï¼Œçº¿ç¨‹æ•°è¾¾åˆ°æœ€å¤§ä¸”éƒ½å¤„äºå·¥ä½œçŠ¶æ€ï¼Œåˆ™ä¼šè°ƒç”¨RejectExecutionHandle è§„å®šçš„æ‹’ç»ç­–ç•¥

å½“ä»»åŠ¡å¤„ç†å®Œæ¯•ï¼Œçº¿ç¨‹æ•°>corePoolSizeï¼Œæ–°å¢çš„ä¸´æ—¶çº¿ç¨‹å¤„äºç©ºé—²çŠ¶æ€è¶…è¿‡ keepAliveTime æ—¶é—´åï¼Œä¸´æ—¶çº¿ç¨‹çš„èµ„æºå°±ä¼šè¢«é‡Šæ”¾

**çº¿ç¨‹æ± å‚æ•°è®¾ç½®çš„ä¸€èˆ¬æ€§ç»éªŒ**ï¼š

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä»»åŠ¡åˆ†ä¸ºIOå¯†é›†å‹å’Œè®¡ç®—å¯†é›†å‹ä¸¤ç§ã€‚

**<font color='red'>è®¡ç®—å¯†é›†å‹</font>**ï¼šåƒCPUï¼Œæ¯”å¦‚éŸ³è§†é¢‘å¤„ç†ã€å›¾åƒå¤„ç†ã€æ•°å­¦è®¡ç®—ç­‰ï¼Œä¸€èˆ¬æ˜¯è®¾ç½®corePoolSizeä¸º**<font color='red'>CPUçš„æ ¸æ•°nï¼‹1</font>**(ç©ºä½™çº¿ç¨‹ï¼Œ+1æ˜¯ä¸ºäº†é¢„é˜²æŸä¸ªçº¿ç¨‹è¢«é˜»å¡æ—¶ï¼Œcpuå¯ä»¥è°ƒç”¨å…¶ä»–çº¿ç¨‹)ï¼Œå¯ä»¥è®©æ¯ä¸ªçº¿ç¨‹éƒ½èƒ½**å……åˆ†åˆ©ç”¨CPUçš„æ¯ä¸ªæ ¸ï¼Œè€Œä¸”çº¿ç¨‹ä¹‹é—´ä¸ç”¨é¢‘ç¹åˆ‡æ¢**ï¼ˆå‡å°‘æ‰“æ¶ã€å‡å°‘å¼€é”€)



**<font color='red'>lĞå¯†é›†å‹</font>**ï¼šåƒç½‘ç»œå¸¦å®½/å†…å­˜ç¡¬ç›˜/æ•°æ®åº“è®¿é—®/æ–‡ä»¶ä¼ è¾“çš„è¯»å†™èµ„æºï¼ŒcorePoolSize å¯ä»¥è®¾ç½®å¤§ä¸€ç‚¹ï¼Œä¸€èˆ¬ç»éªŒå€¼æ˜¯**<font color='red'>2næˆ–n/(1-é˜»å¡ç³»æ•°)</font>**å·¦å³ï¼Œä½†æ˜¯å»ºè®®ä»¥IOçš„èƒ½åŠ›ä¸ºä¸»ï¼ˆè€ƒè™‘IOè®¾å¤‡æ•°é‡å’ŒIOæœ€å¤§å¹¶å‘æ•°ï¼‰ã€‚ï¼ˆCPUå·¥ä½œé‡è¾ƒå°ï¼Œåœ¨ç­‰IOï¼Œå¯èƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œæ‰€ä»¥å°½é‡é€‚å½“å¢åŠ çº¿ç¨‹ã€å¼‚æ­¥IOã€å¢åŠ å¹¶å‘æˆ–è®¾ç½®ç¼“å­˜ï¼‰ã€‚

ç»éªŒåªèƒ½ä½œä¸ºå‚è€ƒï¼Œå…·ä½“è¿˜æ˜¯è¦æ ¹æ®ä¸šåŠ¡ã€‚



ä¼˜åŒ–ç‚¹
1. guava Retryingé‡è¯•
2. å¦‚æœè¯´ä»»åŠ¡æ ¹æœ¬æ²¡æäº¤åˆ°é˜Ÿåˆ—ä¸­(æˆ–è€…é˜Ÿåˆ—æ»¡äº†ï¼‰ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ç”¨å®šæ—¶ä»»åŠ¡æŠŠå¤±è´¥çŠ¶æ€çš„å›¾è¡¨æ”¾åˆ°é˜Ÿåˆ—ä¸­(è¡¥
    å¿)
3. ç»™ä»»åŠ¡å¢åŠ è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶æ ‡è®°ä¸ºå¤±è´¥
4. AIéšæœºç”Ÿæˆçš„å¤±è´¥æƒ…å†µï¼Œåœ¨åç«¯è¿›è¡Œå¤„ç†
5. åå‘å‹åŠ›ï¼Œæ ¹æ®ä¸‹æ¸¸æœåŠ¡çš„ç¹å¿™ç¨‹åº¦æ¥é€‰æ‹©å½“å‰ç³»ç»Ÿçš„ç­–ç•¥ï¼Œæœ€å¤§åŒ–åˆ©ç”¨ç³»ç»Ÿèµ„æº
6. å›¾è¡¨çš„åˆ·æ–°ã€è‡ªåŠ¨åˆ·æ–°ï¼Œè·å–å›¾è¡¨çš„æœ€æ–°çŠ¶æ€
7. æ‰§è¡Œä»»åŠ¡æˆåŠŸæˆ–å¤±è´¥ï¼Œç»™ç”¨æˆ·å‘é€æ¶ˆæ¯ï¼ˆwebSocketã€Server side eventï¼‰
8. æœåŠ¡æ‹†åˆ†ï¼ˆåº”ç”¨è§£è€¦ï¼‰ï¼šæŠŠé•¿è€—æ—¶ã€æ¶ˆè€—èµ„æºçš„ä»»åŠ¡å•ç‹¬æŠ½å–æˆç¨‹åºï¼Œå¹¶ä¸”ä¸å½±å“ä¸»ä¸šåŠ¡

> å¼€å‘

1.ç»™chartè¡¨æ–°å¢ä»»åŠ¡çŠ¶æ€å­—æ®µ(æ¯”å¦‚æ’é˜Ÿä¸­ã€æ‰§è¡Œä¸­ã€å·²å®Œæˆã€å¤±è´¥)ï¼Œä»»åŠ¡æ‰§è¡Œä¿¡æ¯å­—æ®µ(ç”¨äºè®°å½•ä»»åŠ¡æ‰§è¡Œä¸­ã€æˆ–è€…å¤±è´¥çš„ä¸€äº›ä¿¡æ¯)ã€‚

2.ç”¨æˆ·ç‚¹å‡»æ™ºèƒ½åˆ†æé¡µçš„æäº¤æŒ‰é’®æ—¶ï¼Œå…ˆæŠŠå›¾è¡¨ç«‹åˆ»ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œç„¶åæäº¤ä»»åŠ¡ã€‚

3.ä»»åŠ¡:å…ˆä¿®æ”¹å›¾è¡¨ä»»åŠ¡çŠ¶æ€ä¸ºâ€œæ‰§è¡Œä¸­â€ã€‚ç­‰æ‰§è¡ŒæˆåŠŸåï¼Œä¿®æ”¹ä¸ºâ€œå·²å®Œæˆâ€ã€ä¿å­˜æ‰§è¡Œç»“æœ;æ‰§è¡Œå¤±è´¥åï¼ŒçŠ¶æ€ä¿®æ”¹ä¸ºâ€œå¤±è´¥â€ï¼Œè®°å½•ä»»åŠ¡å¤±è´¥ä¿¡æ¯ã€‚

4.ç”¨æˆ·å¯ä»¥åœ¨å›¾è¡¨ç®¡ç†é¡µé¢æŸ¥çœ‹æ‰€æœ‰å›¾è¡¨(å·²ç”Ÿæˆçš„ã€ç”Ÿæˆä¸­çš„ã€ç”Ÿæˆå¤±è´¥ï¼‰çš„ä¿¡æ¯å’ŒçŠ¶æ€ã€‚



### RabbitMQæ¶ˆæ¯é˜Ÿåˆ—é›†æˆ

> ç°åœ¨çš„ç³»ç»Ÿçš„é—®é¢˜

ï¼ˆ1ï¼‰é™æµæ˜¯å±€é™äºå•æœºç¯å¢ƒçš„ï¼Œåªé’ˆå¯¹å•æœºçš„JVMç¯å¢ƒï¼Œä¸é€‚ç”¨äºé›†ç¾¤ç¯å¢ƒ

é›†ä¸­çš„åœ°æ–¹æ¥ç®¡ç†ä»»åŠ¡ä¸‹å‘

ï¼ˆ2ï¼‰ä»»åŠ¡å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¯èƒ½ä¼šä¸¢å¤±

å¯æŒä¹…åŒ–å­˜å‚¨çš„ç¡¬ç›˜

ï¼ˆ3ï¼‰å¦‚æœç³»ç»Ÿè¶Šæ¥è¶Šå¤æ‚ï¼Œä»»åŠ¡ç§ç±»è¶Šæ¥è¶Šå¤šï¼Œä¼šéœ€è¦å¾ˆå¤šçš„çº¿ç¨‹æ± ç­‰é€ æˆèµ„æºæŠ¢å 

æ‹†åˆ†ç³»ç»Ÿ+ä¸­é—´äººï¼Œå¸®åŠ©è¿æ¥å¤šä¸ªç³»ç»Ÿ

ä¸­é—´ä»¶ï¼šè¿æ¥å¤šä¸ªç³»ç»Ÿç´§å¯†åä½œ

> æ¶ˆæ¯é˜Ÿåˆ—

ä¼˜ç‚¹ï¼šè·¨å¹³å° +ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è§£è€¦äº’ä¸å½±å“+å¼‚æ­¥å¤„ç†+å‰Šå³°å¡«è°·+å¯æŒä¹…åŒ–+å¯æ‰©å±•

å‘å¸ƒè®¢é˜…

